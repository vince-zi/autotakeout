<!DOCTYPE html>
<html class="light" lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>æœ€è¿‘10æ¬¡å¤ç›˜æŠ¥å‘Š - åƒä»€ä¹ˆ</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': '#d48f6a',
                        'primary-hover': '#c47f5a',
                        'bg-light': '#faf8f5',
                        'bg-dark': '#1a1512',
                        'card-light': '#ffffff',
                        'card-dark': '#2d231c',
                        'text-main': '#3d2e24',
                        'text-sub': '#8c7b6e',
                        'accent-cream': '#f5ebe0',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-bg-light dark:bg-bg-dark min-h-screen flex flex-col pb-20">
    <main class="flex-1 container mx-auto px-4 py-6 max-w-md">
        <!-- å¤´éƒ¨ -->
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-text-main dark:text-white mb-2">ğŸ“Š æœ€è¿‘10æ¬¡å¤ç›˜æŠ¥å‘Š</h1>
            <p class="text-text-sub text-sm" id="dateRange">åŠ è½½ä¸­...</p>
        </div>

        <!-- æ¦‚è§ˆå¡ç‰‡ -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div
                class="bg-card-light dark:bg-card-dark rounded-2xl p-5 border border-[#f0e6da] dark:border-[#4a3a2f] text-center">
                <div class="text-3xl font-bold text-primary" id="totalMeals">0</div>
                <div class="text-sm text-text-sub mt-1">è®°å½•é¤æ•°</div>
            </div>
            <div
                class="bg-card-light dark:bg-card-dark rounded-2xl p-5 border border-[#f0e6da] dark:border-[#4a3a2f] text-center">
                <div class="text-3xl font-bold text-primary" id="totalSpent">Â¥0</div>
                <div class="text-sm text-text-sub mt-1">æ€»èŠ±è´¹</div>
            </div>
            <div
                class="bg-card-light dark:bg-card-dark rounded-2xl p-5 border border-[#f0e6da] dark:border-[#4a3a2f] text-center">
                <div class="text-3xl font-bold text-yellow-500" id="avgRegret">0</div>
                <div class="text-sm text-text-sub mt-1">å¹³å‡åæ‚”æŒ‡æ•°</div>
            </div>
            <div
                class="bg-card-light dark:bg-card-dark rounded-2xl p-5 border border-[#f0e6da] dark:border-[#4a3a2f] text-center">
                <div class="text-3xl font-bold text-green-500" id="happyRate">0%</div>
                <div class="text-sm text-text-sub mt-1">å¼€å¿ƒé¤å æ¯”</div>
            </div>
        </div>

        <!-- æœ€å®¹æ˜“è®©ä½ æš´é£Ÿçš„é£Ÿç‰© -->
        <div class="bg-card-light dark:bg-card-dark rounded-2xl p-5 border border-[#f0e6da] dark:border-[#4a3a2f] mb-4">
            <h3 class="font-bold text-text-main dark:text-white mb-3 flex items-center gap-2">
                <span class="text-xl">ğŸ”</span>
                æœ€å®¹æ˜“è®©ä½ æš´é£Ÿçš„é£Ÿç‰©
            </h3>
            <div id="bingeList" class="space-y-2">
                <div class="text-text-sub text-sm">æš‚æ— æ•°æ®</div>
            </div>
        </div>

        <!-- æ€§ä»·æ¯”æœ€ä½çš„3æ¬¡å¤–å– -->
        <div class="bg-card-light dark:bg-card-dark rounded-2xl p-5 border border-[#f0e6da] dark:border-[#4a3a2f] mb-4">
            <h3 class="font-bold text-text-main dark:text-white mb-3 flex items-center gap-2">
                <span class="text-xl">ğŸ’¸</span>
                æ€§ä»·æ¯”æœ€ä½çš„3æ¬¡å¤–å–
            </h3>
            <div id="worstValueList" class="space-y-2">
                <div class="text-text-sub text-sm">æš‚æ— æ•°æ®</div>
            </div>
        </div>

        <!-- æœ€å€¼å¾—å¤è´­çš„é£Ÿç‰© -->
        <div class="bg-card-light dark:bg-card-dark rounded-2xl p-5 border border-[#f0e6da] dark:border-[#4a3a2f] mb-4">
            <h3 class="font-bold text-text-main dark:text-white mb-3 flex items-center gap-2">
                <span class="text-xl">â­</span>
                æœ€å€¼å¾—å¤è´­çš„é€‰æ‹©
            </h3>
            <div id="bestChoiceList" class="space-y-2">
                <div class="text-text-sub text-sm">æš‚æ— æ•°æ®</div>
            </div>
        </div>

        <!-- åæ‚”è¶‹åŠ¿ -->
        <div class="bg-card-light dark:bg-card-dark rounded-2xl p-5 border border-[#f0e6da] dark:border-[#4a3a2f] mb-4">
            <h3 class="font-bold text-text-main dark:text-white mb-3 flex items-center gap-2">
                <span class="text-xl">ğŸ“ˆ</span>
                10æ¬¡åæ‚”è¶‹åŠ¿
            </h3>
            <div id="trendChart" class="h-32 flex items-end justify-between gap-1">
                <!-- åŠ¨æ€ç”ŸæˆæŸ±çŠ¶å›¾ -->
            </div>
            <div class="flex justify-between text-xs text-text-sub mt-2">
                <span>7å¤©å‰</span>
                <span>ä»Šå¤©</span>
            </div>
        </div>

        <!-- AI æ™ºèƒ½åˆ†æ -->
        <div
            class="bg-gradient-to-br from-primary/10 to-primary/5 dark:from-primary/20 dark:to-primary/10 rounded-2xl p-5 border border-primary/30 mb-4">
            <h3 class="font-bold text-text-main dark:text-white mb-3 flex items-center gap-2">
                <span class="text-xl">ğŸ¤–</span>
                AI æ™ºèƒ½åˆ†æ
            </h3>
            <p class="text-sm text-text-sub mb-4">åŸºäºä½ æœ€è¿‘10æ¬¡çš„é¥®é£Ÿè®°å½•ï¼ŒAI ä¸ºä½ æä¾›ä¸ªæ€§åŒ–åˆ†æå’Œå»ºè®®</p>

            <div id="aiAnalysisResult" class="hidden mb-4">
                <div
                    class="bg-white/80 dark:bg-card-dark rounded-xl p-4 text-sm text-text-main dark:text-white whitespace-pre-line leading-relaxed">
                    <!-- AI åˆ†æç»“æœä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </div>
            </div>

            <button id="aiAnalyzeBtn"
                class="w-full py-3 bg-primary hover:bg-primary-hover text-white rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-lg">psychology</span>
                è·å– AI åˆ†æ
            </button>
        </div>
    </main>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav
        class="fixed bottom-0 left-0 right-0 bg-card-light dark:bg-card-dark border-t border-[#f0e6da] dark:border-[#4a3a2f] px-4 py-2">
        <div class="max-w-md mx-auto flex justify-around">
            <a href="code.html"
                class="flex flex-col items-center py-2 px-4 text-text-sub hover:text-primary transition-colors">
                <span class="material-symbols-outlined text-xl">restaurant_menu</span>
                <span class="text-xs mt-1">æƒ³åƒå•¥</span>
            </a>
            <a href="review.html"
                class="flex flex-col items-center py-2 px-4 text-text-sub hover:text-primary transition-colors">
                <span class="material-symbols-outlined text-xl">rate_review</span>
                <span class="text-xs mt-1">åƒåå¤ç›˜</span>
            </a>
            <a href="review-history.html" class="flex flex-col items-center py-2 px-4 text-primary">
                <span class="material-symbols-outlined text-xl">analytics</span>
                <span class="text-xs mt-1 font-bold">æ•°æ®æŠ¥å‘Š</span>
            </a>
        </div>
    </nav>

    <script>
        const SUPABASE_URL = 'https://lqqdhlxcfmdgxdayxxsi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcWRobHhjZm1kZ3hkYXl4eHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTQzNzAsImV4cCI6MjA4NTI3MDM3MH0.TkFKzi_UgHjvzgK1zH4thEjQ3fuuotAPwjfkwptdvqU';

        const userToken = localStorage.getItem('user_token') || generateUserToken();

        // å¦‚æœæ²¡æœ‰ç”¨æˆ·tokenï¼Œç”Ÿæˆä¸€ä¸ª
        function generateUserToken() {
            const token = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('user_token', token);
            return token;
        }

        // ç”Ÿæˆ10æ¡éšæœºæµ‹è¯•æ•°æ®
        async function generateTestData() {
            const foods = [
                { name: 'éº»è¾£çƒ«', price: 28 },
                { name: 'è‚¯å¾·åŸºå¥—é¤', price: 35 },
                { name: 'é¥ºå­', price: 22 },
                { name: 'å¥¶èŒ¶+ç‚¸é¸¡', price: 42 },
                { name: 'æ‹‰é¢', price: 32 },
                { name: 'çƒ§çƒ¤', price: 58 },
                { name: 'ä¾¿åˆ©åº—å…³ä¸œç…®', price: 18 },
                { name: 'æŠ«è¨', price: 48 },
                { name: 'ç›–æµ‡é¥­', price: 20 },
                { name: 'ç«é”…å¤–å–', price: 85 }
            ];
            const moods = ['happy', 'satisfied', 'neutral', 'regretful', 'guilty'];
            const fullness = [1, 2, 3]; // 1=å¤ªæ’‘ 2=åˆšå¥½ 3=è¿˜æƒ³åƒ

            const testReviews = foods.map((food, i) => ({
                user_token: userToken,
                food_name: food.name,
                fullness: fullness[Math.floor(Math.random() * fullness.length)],
                mood: moods[Math.floor(Math.random() * moods.length)],
                regret_score: Math.floor(Math.random() * 5) + 1,
                price: food.price,
                note: `æµ‹è¯•æ•°æ® #${i + 1}`,
                created_at: new Date(Date.now() - i * 3600000 * 6).toISOString() // æ¯6å°æ—¶ä¸€æ¡
            }));

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/meal_reviews`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(testReviews)
                });

                if (response.ok) {
                    alert('âœ… å·²ç”Ÿæˆ10æ¡æµ‹è¯•æ•°æ®ï¼æ­£åœ¨åˆ·æ–°...');
                    location.reload();
                } else {
                    const err = await response.text();
                    alert('ç”Ÿæˆå¤±è´¥: ' + err);
                }
            } catch (error) {
                alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
            }
        }

        async function loadReportData() {
            // è·å–æœ€è¿‘10æ¡è®°å½•ï¼ˆä¸é™æ—¥æœŸï¼‰
            document.getElementById('dateRange').textContent = 'æœ€è¿‘10æ¬¡ç”¨é¤è®°å½•';

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/meal_reviews?user_token=eq.${userToken}&order=created_at.desc&limit=10`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');

                const reviews = await response.json();
                cachedReviews = reviews; // ç¼“å­˜ç”¨äºAIåˆ†æ
                renderReport(reviews);
            } catch (error) {
                console.error(error);
                document.getElementById('dateRange').textContent = 'æ•°æ®åŠ è½½å¤±è´¥';
            }
        }

        function renderReport(reviews) {
            if (!reviews.length) {
                document.getElementById('dateRange').textContent = 'æš‚æ— è®°å½•ï¼Œå»è®°å½•ç¬¬ä¸€é¤å§ï¼';
                return;
            }

            // æ¦‚è§ˆæ•°æ®
            document.getElementById('totalMeals').textContent = reviews.length;

            const totalSpent = reviews.reduce((sum, r) => sum + (r.price || 0), 0);
            document.getElementById('totalSpent').textContent = `Â¥${totalSpent.toFixed(0)}`;

            const avgRegret = reviews.reduce((sum, r) => sum + (r.regret_score || 3), 0) / reviews.length;
            document.getElementById('avgRegret').textContent = avgRegret.toFixed(1);

            const happyMeals = reviews.filter(r => ['happy', 'satisfied'].includes(r.mood)).length;
            document.getElementById('happyRate').textContent = `${Math.round(happyMeals / reviews.length * 100)}%`;

            // æš´é£Ÿé£Ÿç‰©ï¼ˆé¥±è…¹æ„Ÿ=1 å¤ªæ’‘äº†ï¼‰
            const bingeEating = reviews.filter(r => r.fullness === 1);
            if (bingeEating.length) {
                document.getElementById('bingeList').innerHTML = bingeEating.slice(0, 3).map(r => `
                    <div class="flex items-center justify-between p-2 bg-red-50 dark:bg-red-900/20 rounded-lg">
                        <span class="text-sm text-text-main dark:text-white">${r.food_name}</span>
                        <span class="text-xs text-red-500">ğŸ˜« åƒå¤ªæ’‘</span>
                    </div>
                `).join('');
            }

            // æ€§ä»·æ¯”æœ€ä½ï¼ˆä»·æ ¼é«˜ + åæ‚”åº¦é«˜ï¼‰
            const worstValue = reviews
                .filter(r => r.price > 0)
                .sort((a, b) => (b.price * b.regret_score) - (a.price * a.regret_score))
                .slice(0, 3);
            if (worstValue.length) {
                document.getElementById('worstValueList').innerHTML = worstValue.map(r => `
                    <div class="flex items-center justify-between p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                        <span class="text-sm text-text-main dark:text-white">${r.food_name}</span>
                        <span class="text-xs text-yellow-600">Â¥${r.price} Â· åæ‚”${r.regret_score}æ˜Ÿ</span>
                    </div>
                `).join('');
            }

            // æœ€å€¼å¾—å¤è´­ï¼ˆåæ‚”åº¦ä½ + å¿ƒæƒ…å¥½ï¼‰
            const bestChoice = reviews
                .filter(r => r.regret_score <= 2 && ['happy', 'satisfied'].includes(r.mood))
                .slice(0, 3);
            if (bestChoice.length) {
                document.getElementById('bestChoiceList').innerHTML = bestChoice.map(r => `
                    <div class="flex items-center justify-between p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
                        <span class="text-sm text-text-main dark:text-white">${r.food_name}</span>
                        <span class="text-xs text-green-600">â­ å€¼å¾—å¤è´­</span>
                    </div>
                `).join('');
            }

            // 10æ¬¡åæ‚”è¶‹åŠ¿æŸ±çŠ¶å›¾ï¼ˆæ˜¾ç¤ºæ¯æ¡è®°å½•ï¼‰
            const chartHtml = reviews.slice(0, 10).reverse().map((r, i) => {
                const score = r.regret_score || 3;
                const height = `${score * 20}%`;
                const color = score > 3 ? 'bg-red-400' : score > 2 ? 'bg-yellow-400' : 'bg-green-400';
                return `
                    <div class="flex-1 flex flex-col items-center">
                        <div class="w-full ${color} rounded-t-sm transition-all" style="height: ${height}"></div>
                        <span class="text-xs text-text-sub mt-1">${score}</span>
                    </div>
                `;
            }).join('');
            document.getElementById('trendChart').innerHTML = chartHtml;
        }

        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        let cachedReviews = []; // ç¼“å­˜è¯„ä»·æ•°æ®ç”¨äºAIåˆ†æ

        if (userToken) {
            loadReportData();
        } else {
            document.getElementById('dateRange').textContent = 'è¯·å…ˆè®°å½•ä¸€é¤å†æŸ¥çœ‹æŠ¥å‘Š';
        }

        // AI æ™ºèƒ½åˆ†æ
        document.getElementById('aiAnalyzeBtn').addEventListener('click', async function () {
            if (cachedReviews.length === 0) {
                alert('æš‚æ— é¥®é£Ÿè®°å½•ï¼Œè¯·å…ˆè®°å½•å‡ é¤åå†è·å–AIåˆ†æ');
                return;
            }

            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined text-lg animate-spin">progress_activity</span> AI åˆ†æä¸­...';

            try {
                // è°ƒç”¨ Edge Function è¿›è¡Œ AI åˆ†æ
                const response = await fetch(`${SUPABASE_URL}/functions/v1/review-analysis`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        reviews: cachedReviews,
                        user_token: userToken
                    })
                });

                if (!response.ok) {
                    throw new Error('AI åˆ†æå¤±è´¥');
                }

                const result = await response.json();

                // æ˜¾ç¤ºAIåˆ†æç»“æœ
                const resultContainer = document.getElementById('aiAnalysisResult');
                resultContainer.querySelector('div').textContent = result.analysis || 'æš‚æ— åˆ†æç»“æœ';
                resultContainer.classList.remove('hidden');

                btn.innerHTML = '<span class="material-symbols-outlined text-lg">check_circle</span> å·²å®Œæˆåˆ†æ';
                btn.classList.replace('bg-primary', 'bg-green-500');

            } catch (error) {
                console.error('AI åˆ†æé”™è¯¯:', error);

                // é™çº§ï¼šä½¿ç”¨æœ¬åœ°ç®€å•åˆ†æ
                const localAnalysis = generateLocalAnalysis(cachedReviews);
                const resultContainer = document.getElementById('aiAnalysisResult');
                resultContainer.querySelector('div').textContent = localAnalysis;
                resultContainer.classList.remove('hidden');

                btn.innerHTML = '<span class="material-symbols-outlined text-lg">psychology</span> é‡æ–°åˆ†æ';
                btn.disabled = false;
            }
        });

        // æœ¬åœ°ç®€å•åˆ†æï¼ˆAIè°ƒç”¨å¤±è´¥æ—¶çš„é™çº§æ–¹æ¡ˆï¼‰
        function generateLocalAnalysis(reviews) {
            const totalMeals = reviews.length;
            const avgRegret = (reviews.reduce((sum, r) => sum + (r.regret_score || 3), 0) / totalMeals).toFixed(1);
            const totalSpent = reviews.reduce((sum, r) => sum + (r.price || 0), 0);
            const avgPrice = (totalSpent / totalMeals).toFixed(0);

            const lateNightMeals = reviews.filter(r => {
                const hour = new Date(r.created_at).getHours();
                return hour >= 21 || hour < 6;
            }).length;

            const highRegretMeals = reviews.filter(r => r.regret_score >= 4);
            const happyMeals = reviews.filter(r => ['happy', 'satisfied'].includes(r.mood));

            let analysis = `ğŸ“Š 7å¤©é¥®é£Ÿæ€»ç»“\n\n`;
            analysis += `ä½ å…±è®°å½•äº† ${totalMeals} é¤ï¼Œå¹³å‡èŠ±è´¹ Â¥${avgPrice}/é¤\n`;
            analysis += `å¹³å‡åæ‚”æŒ‡æ•°ï¼š${avgRegret}/5\n\n`;

            if (lateNightMeals > 0) {
                analysis += `ğŸŒ™ æ·±å¤œåƒäº† ${lateNightMeals} æ¬¡ï¼Œå æ¯” ${Math.round(lateNightMeals / totalMeals * 100)}%\n`;
                analysis += `å»ºè®®ï¼šå°½é‡å‡å°‘æ·±å¤œè¿›é£Ÿï¼Œå¯¹ç¡çœ å’Œæ¶ˆåŒ–éƒ½æ›´å¥½\n\n`;
            }

            if (highRegretMeals.length > 0) {
                analysis += `ğŸ˜… é«˜åæ‚”é¤é£Ÿï¼š${highRegretMeals.map(r => r.food_name).slice(0, 3).join('ã€')}\n`;
                analysis += `å»ºè®®ï¼šä¸‹æ¬¡é¿å¼€è¿™äº›è®©ä½ åæ‚”çš„é€‰æ‹©\n\n`;
            }

            if (happyMeals.length > 0) {
                analysis += `ğŸ˜Š è®©ä½ å¼€å¿ƒçš„é¤é£Ÿï¼š${happyMeals.map(r => r.food_name).slice(0, 3).join('ã€')}\n`;
                analysis += `å»ºè®®ï¼šè¿™äº›æ˜¯å€¼å¾—å¤è´­çš„å¥½é€‰æ‹©ï¼\n`;
            }

            return analysis;
        }
    </script>
</body>

</html>