<!DOCTYPE html>
<html class="light" lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>é¥®é£ŸæŠ¥å‘Š - é¥®é£Ÿè§‰å¯Ÿ</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#d4a574',
                        'primary-hover': '#c49464',
                        'bg-light': '#faf6f0',
                        'bg-dark': '#1a1410',
                        'card-light': '#ffffff',
                        'card-dark': '#2a221c',
                        'text-main': '#3d2e22',
                        'text-sub': '#8b7355',
                        'accent-cream': '#f5e6d3',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-bg-light dark:bg-bg-dark min-h-screen">
    <div class="max-w-md mx-auto px-4 py-6">
        <!-- å¤´éƒ¨ -->
        <header class="flex items-center justify-between mb-6">
            <a href="code.html" class="flex items-center gap-2 text-text-sub hover:text-primary transition-colors">
                <span class="material-symbols-outlined">arrow_back</span>
                <span class="text-sm">è¿”å›</span>
            </a>
            <h1 class="text-lg font-bold text-text-main dark:text-white">ğŸ“Š 7å¤©é¥®é£ŸæŠ¥å‘Š</h1>
            <div class="w-16"></div>
        </header>

        <!-- ä¸»ä½“ -->
        <main class="space-y-6">
            <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
            <div class="grid grid-cols-3 gap-3">
                <div class="bg-card-light dark:bg-card-dark rounded-xl p-4 text-center shadow-sm">
                    <div class="text-2xl font-bold text-primary" id="total-meals">0</div>
                    <div class="text-xs text-text-sub">è®°å½•é¤æ•°</div>
                </div>
                <div class="bg-card-light dark:bg-card-dark rounded-xl p-4 text-center shadow-sm">
                    <div class="text-2xl font-bold text-red-500" id="total-spent">Â¥0</div>
                    <div class="text-xs text-text-sub">æ€»èŠ±è´¹</div>
                </div>
                <div class="bg-card-light dark:bg-card-dark rounded-xl p-4 text-center shadow-sm">
                    <div class="text-2xl font-bold text-yellow-500" id="avg-regret">0</div>
                    <div class="text-xs text-text-sub">å¹³å‡åæ‚”æŒ‡æ•°</div>
                </div>
            </div>

            <!-- æš´é£Ÿé¢„è­¦ -->
            <div class="bg-red-50 dark:bg-red-900/20 rounded-2xl p-5 border border-red-200 dark:border-red-800">
                <h2 class="font-bold text-red-700 dark:text-red-300 mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined">warning</span>
                    æœ€å®¹æ˜“è®©ä½ æš´é£Ÿçš„é£Ÿç‰©
                </h2>
                <div id="binge-foods" class="space-y-2">
                    <p class="text-sm text-red-600 dark:text-red-400">æš‚æ— æ•°æ®ï¼Œç»§ç»­è®°å½•å§ï½</p>
                </div>
            </div>

            <!-- æ€§ä»·æ¯”æœ€ä½ -->
            <div
                class="bg-yellow-50 dark:bg-yellow-900/20 rounded-2xl p-5 border border-yellow-200 dark:border-yellow-800">
                <h2 class="font-bold text-yellow-700 dark:text-yellow-300 mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined">money_off</span>
                    æ€§ä»·æ¯”æœ€ä½çš„3æ¬¡å¤–å–
                </h2>
                <div id="low-value-meals" class="space-y-2">
                    <p class="text-sm text-yellow-600 dark:text-yellow-400">æš‚æ— æ•°æ®ï¼Œç»§ç»­è®°å½•å§ï½</p>
                </div>
            </div>

            <!-- åæ‚”æœ€å¤š -->
            <div class="bg-card-light dark:bg-card-dark rounded-2xl p-5 shadow-sm">
                <h2 class="font-bold text-text-main dark:text-white mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined">sentiment_dissatisfied</span>
                    åæ‚”ç¨‹åº¦æœ€é«˜çš„é¤é£Ÿ
                </h2>
                <div id="most-regret" class="space-y-2">
                    <p class="text-sm text-text-sub">æš‚æ— æ•°æ®ï¼Œç»§ç»­è®°å½•å§ï½</p>
                </div>
            </div>

            <!-- è®°å½•åˆ—è¡¨ -->
            <div class="bg-card-light dark:bg-card-dark rounded-2xl p-5 shadow-sm">
                <h2 class="font-bold text-text-main dark:text-white mb-4 flex items-center justify-between">
                    <span class="flex items-center gap-2">
                        <span class="material-symbols-outlined">history</span>
                        æœ€è¿‘è®°å½•
                    </span>
                    <button id="clear-btn" class="text-xs text-red-500 hover:underline">æ¸…ç©ºæ•°æ®</button>
                </h2>
                <div id="history-list" class="space-y-3">
                    <p class="text-sm text-text-sub text-center py-4">æš‚æ— è®°å½•</p>
                </div>
            </div>

            <!-- å»è®°å½• -->
            <a href="review.html"
                class="block w-full h-14 bg-primary hover:bg-primary-hover text-white rounded-2xl font-bold text-lg shadow-md shadow-primary/20 transition-all flex items-center justify-center gap-2">
                <span class="material-symbols-outlined">add</span>
                è®°å½•ä¸€é¤
            </a>
        </main>
    </div>

    <script>
        // åŠ è½½å†å²æ•°æ®
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('meal_history') || '[]');

            // åªå–æœ€è¿‘7å¤©
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentHistory = history.filter(r => new Date(r.timestamp) > sevenDaysAgo);

            // ç»Ÿè®¡æ¦‚è§ˆ
            document.getElementById('total-meals').textContent = recentHistory.length;

            const totalSpent = recentHistory.reduce((sum, r) => sum + (r.price || 0), 0);
            document.getElementById('total-spent').textContent = 'Â¥' + totalSpent.toFixed(0);

            const avgRegret = recentHistory.length > 0
                ? (recentHistory.reduce((sum, r) => sum + (r.regret || 0), 0) / recentHistory.length).toFixed(1)
                : '0';
            document.getElementById('avg-regret').textContent = avgRegret;

            // æš´é£Ÿé¢„è­¦ï¼ˆé¥±è…¹æ„Ÿ>=4çš„é£Ÿç‰©ï¼‰
            const bingeRecords = recentHistory.filter(r => parseInt(r.fullness) >= 4);
            if (bingeRecords.length > 0) {
                const bingeFoods = [...new Set(bingeRecords.map(r => r.food))];
                document.getElementById('binge-foods').innerHTML = bingeFoods.map(food =>
                    `<div class="flex items-center gap-2 text-red-600 dark:text-red-400">
                        <span>ğŸ”</span>
                        <span class="text-sm font-medium">${food}</span>
                    </div>`
                ).join('');
            }

            // æ€§ä»·æ¯”æœ€ä½ï¼ˆåæ‚”åº¦é«˜ä¸”ä»·æ ¼é«˜ï¼‰
            const scoredMeals = recentHistory
                .filter(r => r.price && r.regret)
                .map(r => ({
                    ...r,
                    valueScore: (r.regret * r.price) // åæ‚”åº¦Ã—ä»·æ ¼=ä½æ€§ä»·æ¯”åˆ†æ•°
                }))
                .sort((a, b) => b.valueScore - a.valueScore)
                .slice(0, 3);

            if (scoredMeals.length > 0) {
                document.getElementById('low-value-meals').innerHTML = scoredMeals.map((meal, i) =>
                    `<div class="flex items-center justify-between text-yellow-600 dark:text-yellow-400">
                        <span class="text-sm">${i + 1}. ${meal.food}</span>
                        <span class="text-sm font-bold">Â¥${meal.price} / åæ‚”${meal.regret}â­</span>
                    </div>`
                ).join('');
            }

            // åæ‚”æœ€å¤š
            const mostRegret = recentHistory
                .filter(r => r.regret >= 4)
                .sort((a, b) => b.regret - a.regret)
                .slice(0, 3);

            if (mostRegret.length > 0) {
                document.getElementById('most-regret').innerHTML = mostRegret.map(meal =>
                    `<div class="flex items-center justify-between">
                        <span class="text-sm text-text-main dark:text-white">${meal.food}</span>
                        <span class="text-sm text-red-500">${'â­'.repeat(meal.regret)}</span>
                    </div>`
                ).join('');
            }

            // å†å²åˆ—è¡¨
            if (recentHistory.length > 0) {
                document.getElementById('history-list').innerHTML = recentHistory
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .slice(0, 10)
                    .map(record => {
                        const date = new Date(record.timestamp);
                        const timeStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                        return `
                            <div class="flex items-center justify-between py-2 border-b border-accent-cream/50 dark:border-[#3a2e26] last:border-0">
                                <div>
                                    <div class="text-sm font-medium text-text-main dark:text-white">${record.food}</div>
                                    <div class="text-xs text-text-sub">${timeStr}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-bold text-primary">${record.price ? 'Â¥' + record.price : '-'}</div>
                                    <div class="text-xs text-text-sub">${record.regret ? 'â­'.repeat(record.regret) : '-'}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
            }
        }

        // æ¸…ç©ºæ•°æ®
        document.getElementById('clear-btn').addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                localStorage.removeItem('meal_history');
                location.reload();
            }
        });

        // åˆå§‹åŒ–
        loadHistory();
    </script>
</body>

</html>