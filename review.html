<!DOCTYPE html>
<html class="light" lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>åƒåå¤ç›˜ - åƒä»€ä¹ˆ</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': '#d48f6a',
                        'primary-hover': '#c47f5a',
                        'bg-light': '#faf8f5',
                        'bg-dark': '#1a1512',
                        'card-light': '#ffffff',
                        'card-dark': '#2d231c',
                        'text-main': '#3d2e24',
                        'text-sub': '#8c7b6e',
                        'accent-cream': '#f5ebe0',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Hiragino Sans GB', sans-serif;
        }

        .emoji-btn.selected {
            background: var(--primary-color, #d48f6a);
            color: white;
            transform: scale(1.1);
        }
    </style>
</head>

<body class="bg-bg-light dark:bg-bg-dark min-h-screen flex flex-col">
    <main class="flex-1 container mx-auto px-4 py-6 max-w-md">
        <!-- å¤´éƒ¨ -->
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-text-main dark:text-white mb-2">ğŸ½ï¸ åƒåå¤ç›˜</h1>
            <p class="text-text-sub text-sm">1åˆ†é’Ÿè®°å½•ï¼Œäº†è§£ä½ çš„é¥®é£Ÿä¹ æƒ¯</p>
        </div>

        <!-- å¤ç›˜è¡¨å• -->
        <form id="reviewForm" class="space-y-6">
            <!-- åˆšæ‰åƒäº†ä»€ä¹ˆ -->
            <div class="bg-card-light dark:bg-card-dark rounded-2xl p-5 border border-[#f0e6da] dark:border-[#4a3a2f]">
                <label class="block text-sm font-bold text-text-main dark:text-white mb-3">
                    <span class="material-symbols-outlined text-primary align-middle mr-1">restaurant</span>
                    åˆšæ‰åƒäº†ä»€ä¹ˆï¼Ÿ
                </label>
                <input type="text" name="food_name" placeholder="å¦‚ï¼šéº»è¾£çƒ«ã€ç‚¸é¸¡ã€æ³¡é¢..."
                    class="w-full px-4 py-3 rounded-xl bg-accent-cream/50 dark:bg-[#3a2e26] border border-[#f0e6da] dark:border-[#4a3a2f] text-text-main dark:text-white placeholder:text-text-sub/50 focus:outline-none focus:ring-2 focus:ring-primary/50" />
            </div>

            <!-- é¥±è…¹æ„Ÿ -->
            <div class="bg-card-light dark:bg-card-dark rounded-2xl p-5 border border-[#f0e6da] dark:border-[#4a3a2f]">
                <label class="block text-sm font-bold text-text-main dark:text-white mb-3">
                    <span class="material-symbols-outlined text-primary align-middle mr-1">sentiment_satisfied</span>
                    é¥±è…¹æ„Ÿå¦‚ä½•ï¼Ÿ
                </label>
                <div class="grid grid-cols-5 gap-2" id="fullnessGroup">
                    <button type="button" data-value="1"
                        class="emoji-btn flex flex-col items-center p-3 rounded-xl bg-accent-cream/50 dark:bg-[#3a2e26] hover:bg-accent-cream dark:hover:bg-[#4a3a2f] transition-all">
                        <span class="text-2xl">ğŸ˜«</span>
                        <span class="text-xs text-text-sub mt-1">å¤ªæ’‘äº†</span>
                    </button>
                    <button type="button" data-value="2"
                        class="emoji-btn flex flex-col items-center p-3 rounded-xl bg-accent-cream/50 dark:bg-[#3a2e26] hover:bg-accent-cream dark:hover:bg-[#4a3a2f] transition-all">
                        <span class="text-2xl">ğŸ˜Œ</span>
                        <span class="text-xs text-text-sub mt-1">åˆšå¥½</span>
                    </button>
                    <button type="button" data-value="3"
                        class="emoji-btn flex flex-col items-center p-3 rounded-xl bg-accent-cream/50 dark:bg-[#3a2e26] hover:bg-accent-cream dark:hover:bg-[#4a3a2f] transition-all">
                        <span class="text-2xl">ğŸ˜</span>
                        <span class="text-xs text-text-sub mt-1">ä¸€èˆ¬</span>
                    </button>
                    <button type="button" data-value="4"
                        class="emoji-btn flex flex-col items-center p-3 rounded-xl bg-accent-cream/50 dark:bg-[#3a2e26] hover:bg-accent-cream dark:hover:bg-[#4a3a2f] transition-all">
                        <span class="text-2xl">ğŸ¤”</span>
                        <span class="text-xs text-text-sub mt-1">æ²¡åƒé¥±</span>
                    </button>
                    <button type="button" data-value="5"
                        class="emoji-btn flex flex-col items-center p-3 rounded-xl bg-accent-cream/50 dark:bg-[#3a2e26] hover:bg-accent-cream dark:hover:bg-[#4a3a2f] transition-all">
                        <span class="text-2xl">ğŸ˜¢</span>
                        <span class="text-xs text-text-sub mt-1">è¿˜é¥¿</span>
                    </button>
                </div>
                <input type="hidden" name="fullness" value="">
            </div>

            <!-- æƒ…ç»ª -->
            <div class="bg-card-light dark:bg-card-dark rounded-2xl p-5 border border-[#f0e6da] dark:border-[#4a3a2f]">
                <label class="block text-sm font-bold text-text-main dark:text-white mb-3">
                    <span class="material-symbols-outlined text-primary align-middle mr-1">mood</span>
                    åƒå®Œåå¿ƒæƒ…å¦‚ä½•ï¼Ÿ
                </label>
                <div class="grid grid-cols-5 gap-2" id="moodGroup">
                    <button type="button" data-value="happy"
                        class="emoji-btn flex flex-col items-center p-3 rounded-xl bg-accent-cream/50 dark:bg-[#3a2e26] hover:bg-accent-cream dark:hover:bg-[#4a3a2f] transition-all">
                        <span class="text-2xl">ğŸ˜Š</span>
                        <span class="text-xs text-text-sub mt-1">å¼€å¿ƒ</span>
                    </button>
                    <button type="button" data-value="satisfied"
                        class="emoji-btn flex flex-col items-center p-3 rounded-xl bg-accent-cream/50 dark:bg-[#3a2e26] hover:bg-accent-cream dark:hover:bg-[#4a3a2f] transition-all">
                        <span class="text-2xl">ğŸ˜‹</span>
                        <span class="text-xs text-text-sub mt-1">æ»¡è¶³</span>
                    </button>
                    <button type="button" data-value="neutral"
                        class="emoji-btn flex flex-col items-center p-3 rounded-xl bg-accent-cream/50 dark:bg-[#3a2e26] hover:bg-accent-cream dark:hover:bg-[#4a3a2f] transition-all">
                        <span class="text-2xl">ğŸ˜</span>
                        <span class="text-xs text-text-sub mt-1">ä¸€èˆ¬</span>
                    </button>
                    <button type="button" data-value="guilty"
                        class="emoji-btn flex flex-col items-center p-3 rounded-xl bg-accent-cream/50 dark:bg-[#3a2e26] hover:bg-accent-cream dark:hover:bg-[#4a3a2f] transition-all">
                        <span class="text-2xl">ğŸ˜”</span>
                        <span class="text-xs text-text-sub mt-1">å†…ç–š</span>
                    </button>
                    <button type="button" data-value="regret"
                        class="emoji-btn flex flex-col items-center p-3 rounded-xl bg-accent-cream/50 dark:bg-[#3a2e26] hover:bg-accent-cream dark:hover:bg-[#4a3a2f] transition-all">
                        <span class="text-2xl">ğŸ˜­</span>
                        <span class="text-xs text-text-sub mt-1">åæ‚”</span>
                    </button>
                </div>
                <input type="hidden" name="mood" value="">
            </div>

            <!-- åæ‚”åº¦ -->
            <div class="bg-card-light dark:bg-card-dark rounded-2xl p-5 border border-[#f0e6da] dark:border-[#4a3a2f]">
                <label class="block text-sm font-bold text-text-main dark:text-white mb-3">
                    <span class="material-symbols-outlined text-primary align-middle mr-1">sentiment_dissatisfied</span>
                    åæ‚”ç¨‹åº¦
                </label>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-text-sub">ä¸åæ‚”</span>
                    <input type="range" name="regret" min="1" max="5" value="3"
                        class="flex-1 h-2 bg-accent-cream dark:bg-[#3a2e26] rounded-full appearance-none cursor-pointer accent-primary" />
                    <span class="text-sm text-text-sub">å¾ˆåæ‚”</span>
                </div>
                <div class="flex justify-between mt-2 text-xs text-text-sub">
                    <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
                </div>
            </div>

            <!-- èŠ±äº†å¤šå°‘é’± -->
            <div class="bg-card-light dark:bg-card-dark rounded-2xl p-5 border border-[#f0e6da] dark:border-[#4a3a2f]">
                <label class="block text-sm font-bold text-text-main dark:text-white mb-3">
                    <span class="material-symbols-outlined text-primary align-middle mr-1">payments</span>
                    èŠ±äº†å¤šå°‘é’±ï¼Ÿ
                </label>
                <div class="flex items-center gap-2">
                    <span class="text-xl text-primary font-bold">Â¥</span>
                    <input type="number" name="price" placeholder="0.00" min="0" step="0.01"
                        class="flex-1 px-4 py-3 rounded-xl bg-accent-cream/50 dark:bg-[#3a2e26] border border-[#f0e6da] dark:border-[#4a3a2f] text-text-main dark:text-white placeholder:text-text-sub/50 focus:outline-none focus:ring-2 focus:ring-primary/50 text-2xl font-bold" />
                </div>
            </div>

            <!-- å¤‡æ³¨ -->
            <div class="bg-card-light dark:bg-card-dark rounded-2xl p-5 border border-[#f0e6da] dark:border-[#4a3a2f]">
                <label class="block text-sm font-bold text-text-main dark:text-white mb-3">
                    <span class="material-symbols-outlined text-primary align-middle mr-1">edit_note</span>
                    æƒ³è¯´ç‚¹ä»€ä¹ˆï¼Ÿï¼ˆå¯é€‰ï¼‰
                </label>
                <textarea name="note" rows="2" placeholder="æ¯”å¦‚ï¼šä¸‹æ¬¡ä¸ç‚¹è¿™ä¹ˆå¤šäº†..."
                    class="w-full px-4 py-3 rounded-xl bg-accent-cream/50 dark:bg-[#3a2e26] border border-[#f0e6da] dark:border-[#4a3a2f] text-text-main dark:text-white placeholder:text-text-sub/50 focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none"></textarea>
            </div>

            <!-- æäº¤æŒ‰é’® -->
            <button type="submit"
                class="w-full h-14 bg-primary hover:bg-primary-hover text-white rounded-2xl font-bold text-lg shadow-lg shadow-primary/20 transition-all flex items-center justify-center gap-2">
                <span class="material-symbols-outlined">check_circle</span>
                è®°å½•è¿™ä¸€é¤
            </button>
        </form>
    </main>

    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://lqqdhlxcfmdgxdayxxsi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcWRobHhjZm1kZ3hkYXl4eHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTQzNzAsImV4cCI6MjA4NTI3MDM3MH0.TkFKzi_UgHjvzgK1zH4thEjQ3fuuotAPwjfkwptdvqU';

        // è¡¨æƒ…æŒ‰é’®é€‰æ‹©é€»è¾‘
        document.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const group = btn.closest('[id$="Group"]');
                const hiddenInput = group.nextElementSibling;

                // ç§»é™¤åŒç»„å…¶ä»–é€‰ä¸­çŠ¶æ€
                group.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');

                // è®¾ç½®éšè—å­—æ®µå€¼
                hiddenInput.value = btn.dataset.value;
            });
        });

        // è¡¨å•æäº¤
        document.getElementById('reviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;
            const data = {
                food_name: form.food_name.value,
                fullness: parseInt(form.fullness.value) || 3,
                mood: form.mood.value || 'neutral',
                regret_score: parseInt(form.regret.value),
                price: parseFloat(form.price.value) || 0,
                note: form.note.value,
                created_at: new Date().toISOString(),
                user_token: localStorage.getItem('user_token') || generateUserToken()
            };

            if (!data.food_name) {
                alert('è¯·å¡«å†™åƒäº†ä»€ä¹ˆ');
                return;
            }

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/meal_reviews`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showToast('âœ… è®°å½•æˆåŠŸï¼');
                    // ä¿å­˜æˆåŠŸåè·³è½¬åˆ°ä¸»é¡µ
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } else {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error(error);
                showToast('âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            }
        });

        // ç”ŸæˆåŒ¿åç”¨æˆ·token
        function generateUserToken() {
            const token = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('user_token', token);
            return token;
        }

        // Toastæç¤º
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-card-dark text-white px-6 py-3 rounded-xl shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.transition = 'opacity 0.3s';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
    </script>
</body>

</html>