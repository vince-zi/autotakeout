<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        name="viewport" />
    <title>æ­£åœ¨å¯»æ‰¾ - é¥®é£Ÿè§‰å¯Ÿ</title>
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <link href="https://api.fontshare.com/v2/css?f[]=zodiak@400,500,700&f[]=pally@400,500,700&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cream: '#fffcf8',
                        dusty: { rose: '#d9a59d', 'rose-light': '#f4e4e1', 'rose-dark': '#b57b72' },
                        sage: { green: '#c8d5c4', 'green-light': '#e8f0e6', 'green-dark': '#8a9a85' },
                        charcoal: '#5c5552',
                        'text-light': '#948c89'
                    },
                    fontFamily: { serif: ['Zodiak', 'serif'], sans: ['Pally', 'sans-serif'] },
                    boxShadow: {
                        'bubble': '0 8px 24px -6px rgba(217, 165, 157, 0.25)',
                        'bubble-hover': '0 12px 32px -8px rgba(217, 165, 157, 0.4)',
                        'glass': '0 8px 32px 0 rgba(217, 165, 157, 0.15)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'float-delayed': 'float 6s ease-in-out 3s infinite',
                        'pulse-soft': 'pulse-soft 2s infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-20px)' } },
                        'pulse-soft': { '0%, 100%': { opacity: 1 }, '50%': { opacity: 0.7 } }
                    }
                }
            }
        }
    </script>
    <style>
        /* CSS Safe Fallback */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        .animate-float-delayed {
            animation: float 6s ease-in-out 3s infinite;
        }
    </style>
</head>

<body
    class="min-h-screen bg-cream text-charcoal font-sans p-6 flex flex-col items-center justify-center relative overflow-hidden">

    <!-- Background Blobs -->
    <div
        class="fixed top-[-10%] left-[-10%] w-[500px] h-[500px] rounded-full bg-sage-green/20 blur-[100px] animate-float pointer-events-none z-0">
    </div>
    <div
        class="fixed bottom-[-10%] right-[-10%] w-[600px] h-[600px] rounded-full bg-dusty-rose/10 blur-[100px] animate-float-delayed pointer-events-none z-0">
    </div>

    <!-- Main Container -->
    <div class="w-full max-w-md relative z-10">

        <div class="bg-white/40 backdrop-blur-md border border-white/60 rounded-[2.5rem] p-8 md:p-12 shadow-glass text-center min-h-[400px] flex flex-col items-center justify-center transition-all duration-500"
            id="card-container">

            <!-- Icon -->
            <div class="mb-6 text-6xl animate-bounce-soft" id="icon">ğŸœ</div>

            <!-- Titles -->
            <h1 class="font-serif text-3xl md:text-4xl font-bold text-charcoal mb-3" id="title">æ­£åœ¨ä¸ºä½ å¯»æ‰¾æ…°è—‰...</h1>
            <p class="text-text-light text-lg mb-10 leading-relaxed" id="subtitle">è®©ç¾é£Ÿæ²»æ„ˆä»Šå¤©çš„ç–²æƒ«</p>

            <!-- Loader -->
            <div class="flex flex-col items-center gap-4" id="loader">
                <div class="w-12 h-12 border-4 border-sage-green/30 border-t-sage-green rounded-full animate-spin">
                </div>
                <span class="text-sm font-bold text-sage-green-dark uppercase tracking-widest animate-pulse-soft"
                    id="loaderText">æ­£åœ¨åŒ¹é…...</span>
            </div>

            <!-- Ready State -->
            <div class="hidden w-full space-y-6 pt-4 animate-fade-in-up" id="readyState">
                <button id="actionBtn" onclick="goToEleme()"
                    class="w-full py-5 rounded-full bg-dusty-rose text-white font-bold text-xl shadow-bubble hover:shadow-bubble-hover hover:-translate-y-1 transition-all flex items-center justify-center gap-3 group">
                    <span>ğŸœ å¼€ç‚«å§</span>
                    <iconify-icon icon="lucide:external-link"
                        class="text-lg opacity-60 group-hover:opacity-100 transition-opacity"></iconify-icon>
                </button>
                <p class="text-xs text-text-light font-medium tracking-wide">ç‚¹å‡»è‡ªåŠ¨æ‰“å¼€é¥¿äº†ä¹ˆApp</p>

                <!-- Feedback Section -->
                <div id="feedbackSection" style="display: none;" class="pt-6 border-t border-dashed border-charcoal/10">
                    <p class="text-sm text-text-light mb-4 font-medium">ä¸‹å•äº†å—ï¼Ÿ</p>
                    <div class="flex gap-3 justify-center">
                        <a href="review.html"
                            class="flex-1 py-3 px-4 rounded-2xl bg-sage-green text-white font-bold text-sm shadow-sm hover:shadow-md transition-all flex items-center justify-center gap-2">
                            <iconify-icon icon="lucide:check"></iconify-icon> å·²ä¸‹å•
                        </a>
                        <button onclick="reRecommend()"
                            class="flex-1 py-3 px-4 rounded-2xl bg-white text-text-light font-bold text-sm shadow-sm border border-transparent hover:border-dusty-rose/30 transition-all flex items-center justify-center gap-2">
                            <iconify-icon icon="lucide:refresh-cw"></iconify-icon> æ¢ä¸€ä¸ª
                        </button>
                    </div>
                </div>
            </div>

            <!-- Error State -->
            <div class="hidden w-full pt-8" id="errorState">
                <p class="text-dusty-rose font-bold mb-6">è·å–æ¨èæ—¶é‡åˆ°é—®é¢˜</p>
                <button onclick="location.href='index.html'"
                    class="px-8 py-3 rounded-full bg-white text-charcoal font-bold shadow-sm hover:shadow-md transition-all">é‡æ–°å¼€å§‹</button>
            </div>

        </div>
    </div>

    <!-- Original Logic (Preserved) -->
    <script>
        const SUPABASE_URL = 'https://lqqdhlxcfmdgxdayxxsi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcWRobHhjZm1kZ3hkYXl4eHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTQzNzAsImV4cCI6MjA4NTI3MDM3MH0.TkFKzi_UgHjvzgK1zH4thEjQ3fuuotAPwjfkwptdvqU';

        const userChoices = JSON.parse(sessionStorage.getItem('userChoices') || '{}');
        const choiceLabels = JSON.parse(sessionStorage.getItem('choiceLabels') || '{}');

        // ========== åŠ¨æ€æ–‡æ¡ˆç”Ÿæˆ ==========
        // æ ¹æ®ç”¨æˆ·é€‰æ‹©ç”Ÿæˆæƒ…æ„ŸåŒ–ç­‰å¾…æ–‡æ¡ˆ
        const copyTemplates = {
            // å¤œæ™š + å„ç§å¿ƒæƒ…
            'nighttime_stressed': {
                icon: 'ğŸŒ™',
                title: 'å¤œæ·±äº†ï¼Œä½ è¿˜åœ¨æ‰›ç€',
                subtitle: 'æ”¾ä¸‹é‚£äº›æ²‰é‡ï¼Œè®©ä¸€ä»½çƒ­è…¾è…¾çš„ç¾é£Ÿæ¸©æš–ä½ ',
                loader: 'æ­£åœ¨å¯»æ‰¾èƒ½æ²»æ„ˆä½ çš„å‘³é“...'
            },
            'nighttime_homesick': {
                icon: 'ğŸ ',
                title: 'æƒ³å®¶çš„å¤œæ™š',
                subtitle: 'è™½ç„¶å›ä¸å»ï¼Œä½†ç†Ÿæ‚‰çš„å‘³é“èƒ½å¸¦ä½ å›å®¶',
                loader: 'æ­£åœ¨å¯»æ‰¾é‚£ä»½æ¸©æš–...'
            },
            'nighttime_finished_work': {
                icon: 'ğŸ‰',
                title: 'ç»ˆäºç†¬å®Œäº†ï¼',
                subtitle: 'å¤œå®µæ—¶é—´ï¼Œä½ å€¼å¾—å¥½å¥½çŠ’åŠ³è‡ªå·±',
                loader: 'æ­£åœ¨å‡†å¤‡ä½ çš„å¥–åŠ±...'
            },
            'nighttime_lonely': {
                icon: 'ğŸŒƒ',
                title: 'ä¸€ä¸ªäººçš„å¤œæ™š',
                subtitle: 'ç¾é£Ÿä¸ä¼šè®©ä½ å­¤å•ï¼Œå®ƒä¼šé™é™é™ªç€ä½ ',
                loader: 'æ­£åœ¨å¯»æ‰¾é™ªä¼´ä½ çš„å‘³é“...'
            },

            // ç™½å¤© + å„ç§å¿ƒæƒ…
            'daytime_stressed': {
                icon: 'ğŸ˜®â€ğŸ’¨',
                title: 'ä»Šå¤©æœ‰ç‚¹ç´¯äº†',
                subtitle: 'åœä¸‹æ¥ï¼Œç”¨ç¾é£Ÿç»™è‡ªå·±æŒ‰ä¸ªæš‚åœé”®',
                loader: 'æ­£åœ¨å¯»æ‰¾èƒ½è®©ä½ å–˜å£æ°”çš„é€‰æ‹©...'
            },
            'daytime_homesick': {
                icon: 'ğŸ¥˜',
                title: 'çªç„¶æƒ³å®¶äº†',
                subtitle: 'ä¸€ç¢—å®¶å¸¸çš„å‘³é“ï¼Œä¹Ÿè®¸èƒ½å¡«è¡¥é‚£ä»½æƒ³å¿µ',
                loader: 'æ­£åœ¨å¯»æ‰¾å®¶çš„å‘³é“...'
            },
            'daytime_finished_work': {
                icon: 'âœ¨',
                title: 'å¿™å®Œäº†ï¼',
                subtitle: 'æ˜¯æ—¶å€™çŠ’åŠ³ä¸€ä¸‹è¾›è‹¦çš„è‡ªå·±äº†',
                loader: 'æ­£åœ¨å‡†å¤‡ä½ çš„åº†åŠŸå®´...'
            },
            'daytime_lonely': {
                icon: 'ğŸ½ï¸',
                title: 'ä¸€äººé£Ÿ',
                subtitle: 'ç‹¬å¤„ä¹Ÿå¯ä»¥æ˜¯ä¸€ç§äº«å—ï¼Œæ…¢æ…¢æ¥',
                loader: 'æ­£åœ¨æŒ‘é€‰é€‚åˆç‹¬äº«çš„ç¾å‘³...'
            },

            // é»˜è®¤
            'default': {
                icon: 'ğŸœ',
                title: 'æ­£åœ¨ä¸ºä½ å¯»æ‰¾æ…°è—‰',
                subtitle: 'è®©ç¾é£Ÿæ²»æ„ˆæ­¤åˆ»çš„ä½ ',
                loader: 'æ­£åœ¨åŒ¹é…æœ€é€‚åˆä½ çš„é€‰æ‹©...'
            }
        };

        // æ ¹æ®é¥¥é¥¿ç¨‹åº¦æ·»åŠ é¢å¤–æ–‡æ¡ˆ
        const hungerModifiers = {
            'culinary_hug': 'æ¸©æŸ”åœ°',
            'crunch': 'é…¥è„†åœ°',
            'energy_needed': 'å¿«é€Ÿåœ°'
        };

        // æ›´æ–°é¡µé¢æ–‡æ¡ˆ
        function updateCopywriting() {
            const time = userChoices.time_of_day || 'daytime';
            const mood = userChoices.mood || 'stressed';
            const key = `${time}_${mood}`;

            const copy = copyTemplates[key] || copyTemplates['default'];

            document.getElementById('icon').textContent = copy.icon;
            document.getElementById('title').textContent = copy.title;
            document.getElementById('subtitle').textContent = copy.subtitle;
            document.getElementById('loaderText').textContent = copy.loader;
        }

        // ========== é¥¿äº†ä¹ˆè·³è½¬ ==========
        function getElemeUrl(keyword) {
            // ä½¿ç”¨ç½‘é¡µç‰ˆç¡®ä¿å…¼å®¹æ€§
            return `https://h5.ele.me/msite/search?keyword=${encodeURIComponent(keyword)}`;
        }

        // å°è¯•æ‰“å¼€é¥¿äº†ä¹ˆAppï¼ˆåªæ‰“å¼€ä¸€æ¬¡ï¼Œä¸è‡ªåŠ¨fallbackï¼‰
        function jumpToEleme(keyword) {
            // ä¿å­˜å…³é”®è¯ä¾›è¿”å›åä½¿ç”¨
            sessionStorage.setItem('pendingOrder', JSON.stringify({
                keyword: keyword,
                timestamp: Date.now()
            }));

            // å°è¯•æ‰“å¼€Appï¼ˆiOS/Androidéƒ½æ”¯æŒï¼‰
            const appScheme = `eleme://search?keyword=${encodeURIComponent(keyword)}`;

            // ç›´æ¥è·³è½¬ï¼Œä¸åšfallbackï¼ˆé¿å…äºŒæ¬¡è·³è½¬ï¼‰
            window.location.href = appScheme;
        }

        // ========== ä¿å­˜æ¨èè®°å½• ==========
        async function saveRecommendation(data) {
            try {
                const userToken = localStorage.getItem('user_token') || generateToken();
                const rec = data.recommendations?.[0];

                if (!rec) return;

                await fetch(`${SUPABASE_URL}/rest/v1/meal_reviews`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        user_token: userToken,
                        food_name: rec.food_name || 'å¾…é€‰æ‹©',
                        price: parseFloat(rec.estimated_price) || 0,
                        fullness: 2,
                        mood: 'satisfied',
                        regret_score: rec.regret_score || 2,
                        note: `AIæ¨è - ${choiceLabels.mood || ''} - ${rec.restaurant || 'é¥¿äº†ä¹ˆ'}`,
                        created_at: new Date().toISOString()
                    })
                });
            } catch (e) {
                console.log('ä¿å­˜è®°å½•å¤±è´¥:', e);
            }
        }

        function generateToken() {
            const token = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('user_token', token);
            return token;
        }

        // å­˜å‚¨å½“å‰å…³é”®è¯ä¾›æŒ‰é’®ä½¿ç”¨
        let currentKeyword = 'å¤–å–';

        // æŒ‰é’®æ–‡æ¡ˆï¼ˆæ ¹æ®å¿ƒæƒ…ï¼‰
        const actionButtonTexts = {
            stressed: 'ğŸ”¥ é‡Šæ”¾ä¸€ä¸‹',
            homesick: 'ğŸ  å›å‘³å®¶çš„å‘³é“',
            finished_work: 'ğŸ‰ å¼€ç‚«å§',
            lonely: 'ğŸ¥£ æ¸©æš–ä¸€ä¸‹'
        };

        // ç‚¹å‡»æŒ‰é’®è·³è½¬é¥¿äº†ä¹ˆ
        function goToEleme() {
            // ä¿å­˜å½“å‰æ¨èä¿¡æ¯ä¾›reviewé¡µé¢ä½¿ç”¨
            sessionStorage.setItem('currentRecommendation', JSON.stringify({
                keyword: currentKeyword,
                mood: userChoices.mood,
                time: userChoices.time_of_day,
                timestamp: Date.now()
            }));

            // æ˜¾ç¤ºåé¦ˆæŒ‰é’®
            document.getElementById('feedbackSection').style.display = 'block';

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const actionBtn = document.getElementById('actionBtn');
            // Hacky visual update to button
            actionBtn.querySelector('span').innerText = 'âœ… å·²è·³è½¬';
            actionBtn.classList.remove('bg-dusty-rose');
            actionBtn.classList.add('bg-sage-green');

            actionBtn.onclick = null; // ç¦ç”¨å†æ¬¡ç‚¹å‡»

            // ç”¨æˆ·ç¡®è®¤è¦è·³è½¬ï¼Œæ¸…é™¤æ’é™¤åˆ—è¡¨ï¼ˆä¸‹å•çš„é£Ÿå“ä¸‹æ¬¡å¯ä»¥å†æ¨ï¼‰
            sessionStorage.removeItem('excludedFoods');

            // è·³è½¬åˆ°é¥¿äº†ä¹ˆ
            jumpToEleme(currentKeyword);
        }

        // æ˜¾ç¤ºå‡†å¤‡å°±ç»ªçŠ¶æ€
        function showReady(keyword) {
            currentKeyword = keyword;

            // ä¿å­˜å·²æ¨èçš„é£Ÿå“åˆ°æ’é™¤åˆ—è¡¨ï¼ˆç”¨äºâ€œæ¢ä¸€ä¸ªâ€æ—¶æ’é™¤ï¼‰
            const excludedFoods = JSON.parse(sessionStorage.getItem('excludedFoods') || '[]');
            if (keyword && !excludedFoods.includes(keyword)) {
                excludedFoods.push(keyword);
                sessionStorage.setItem('excludedFoods', JSON.stringify(excludedFoods));
            }

            // éšè—åŠ è½½åŠ¨ç”»
            document.getElementById('loader').style.display = 'none';

            // æ›´æ–°æ ‡é¢˜æ–‡æ¡ˆ
            const readyTitles = {
                stressed: 'æ‰¾åˆ°äº†ï¼',
                homesick: 'è¿™ä¸ªå‘³é“åº”è¯¥æ²¡é”™',
                finished_work: 'å‡†å¤‡å¥½äº†ï¼',
                lonely: 'æš–å¿ƒæ¨èæ¥äº†'
            };
            document.getElementById('title').textContent = readyTitles[userChoices.mood] || 'æ‰¾åˆ°äº†ï¼';
            document.getElementById('subtitle').textContent = 'ä¸ºä½ ç²¾é€‰çš„ç¾é£Ÿå·²å°±ä½';

            // æ›´æ–°æŒ‰é’®æ–‡æ¡ˆ
            const btnText = actionButtonTexts[userChoices.mood] || 'ğŸœ å¼€ç‚«å§';
            document.getElementById('actionBtn').querySelector('span').innerText = btnText;

            // æ˜¾ç¤ºå‡†å¤‡å°±ç»ªçŠ¶æ€
            const readyDiv = document.getElementById('readyState');
            readyDiv.classList.remove('hidden');
            readyDiv.classList.add('block');
        }

        // ========== è·å–AIæ¨è ==========
        async function getRecommendation() {
            // é»˜è®¤å…³é”®è¯ï¼ˆæ ¹æ®å¿ƒæƒ…ï¼‰
            const moodKeywords = {
                stressed: 'éº»è¾£çƒ«',
                homesick: 'å®¶å¸¸èœ',
                finished_work: 'ç«é”…',
                lonely: 'ç²¥'
            };
            const defaultKeyword = moodKeywords[userChoices.mood] || 'å¤–å–';

            try {
                // è·å–æ’é™¤åˆ—è¡¨ï¼ˆæ¨èè¿‡ä½†æ²¡ä¸‹å•çš„é£Ÿå“ï¼‰
                const excludedFoods = JSON.parse(sessionStorage.getItem('excludedFoods') || '[]');

                const response = await fetch(`${SUPABASE_URL}/functions/v1/recommend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        ...userChoices,
                        excluded_foods: excludedFoods  // ä¼ é€’æ’é™¤åˆ—è¡¨ç»™ AI
                    })
                });

                if (response.ok) {
                    const data = await response.json();

                    // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œä¿å­˜è®°å½•ï¼Œæ”¹ä¸ºç”¨æˆ·ç¡®è®¤ä¸‹å•åå†ä¿å­˜

                    // è·å–AIè¿”å›çš„å…³é”®è¯
                    const aiKeyword = data.recommendations?.[0]?.jump_keyword ||
                        data.recommendations?.[0]?.food_name ||
                        defaultKeyword;

                    // æ˜¾ç¤ºå‡†å¤‡å°±ç»ªæŒ‰é’®ï¼ˆè€Œä¸æ˜¯ç›´æ¥è·³è½¬ï¼‰
                    showReady(aiKeyword);
                } else {
                    throw new Error('API Error');
                }
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                // å³ä½¿å¤±è´¥ä¹Ÿæ˜¾ç¤ºæŒ‰é’®ï¼Œä½¿ç”¨é»˜è®¤å…³é”®è¯
                showReady(defaultKeyword);
            }
        }

        // ========== æ˜¾ç¤ºé”™è¯¯ ==========
        function showError() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorState').classList.add('block');
        }

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·é€‰æ‹©
            if (!userChoices.time_of_day) {
                window.location.href = 'index.html';
                return;
            }

            // æ–°æµç¨‹å¼€å§‹ï¼Œæ¸…é™¤ä¹‹å‰å¯èƒ½ç•™ä¸‹çš„ pendingOrder
            sessionStorage.removeItem('pendingOrder');

            // æ›´æ–°æ–‡æ¡ˆ
            updateCopywriting();

            // å¼€å§‹è·å–æ¨è
            getRecommendation();
        });

        // ========== é‡æ–°æ¨è ==========
        function reRecommend() {
            // éšè—åé¦ˆåŒºåŸŸ
            document.getElementById('feedbackSection').style.display = 'none';

            // æ¢å¤åŠ è½½çŠ¶æ€
            document.getElementById('loader').style.display = 'flex';
            const readyDiv = document.getElementById('readyState');
            readyDiv.classList.add('hidden');
            readyDiv.classList.remove('block');

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const actionBtn = document.getElementById('actionBtn');
            actionBtn.querySelector('span').innerText = 'ğŸœ å¼€ç‚«å§';
            actionBtn.classList.add('bg-dusty-rose');
            actionBtn.classList.remove('bg-sage-green');
            actionBtn.onclick = goToEleme;

            // æ›´æ–°æç¤ºæ–‡å­—
            document.getElementById('title').textContent = 'æ¢ä¸€ä¸ªè¯•è¯•...';
            document.getElementById('subtitle').textContent = 'æ­£åœ¨å¯»æ‰¾å…¶ä»–ç¾é£Ÿ';
            document.getElementById('loaderText').textContent = 'æ­£åœ¨é‡æ–°æ¨è...';

            // é‡æ–°è°ƒç”¨ AI
            getRecommendation();
        }
    </script>
</body>

</html>