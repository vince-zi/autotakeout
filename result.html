<!DOCTYPE html>
<html class="light" lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>ä»Šæ™šå°±åƒè¿™ä¸ª - åƒä»€ä¹ˆ</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ff9478",
                        "primary-hover": "#ff7e5f",
                        "background-light": "#fff9f2",
                        "background-dark": "#2d231e",
                        "card-light": "#ffffff",
                        "card-dark": "#3a2e26",
                        "text-main": "#4a3b32",
                        "text-sub": "#9c8676",
                        "accent-cream": "#faefe6",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "system-ui", "sans-serif"],
                        "serif": ["Noto Serif SC", "serif"],
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "2xl": "2rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .recommendation-card {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }

        .recommendation-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .recommendation-card:nth-child(2) {
            animation-delay: 0.25s;
        }

        .recommendation-card:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .regret-star {
            transition: all 0.2s ease;
        }

        .pulse-soft {
            animation: pulseSoft 2s ease-in-out infinite;
        }

        @keyframes pulseSoft {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-text-main dark:text-[#ede0d4] font-display min-h-screen flex flex-col overflow-x-hidden transition-colors duration-300 selection:bg-primary/20">
    <header
        class="w-full border-b border-[#f0e6da] dark:border-[#4a3a2f] bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="text-primary">
                    <span class="material-symbols-outlined text-3xl">local_dining</span>
                </div>
                <h2 class="text-lg font-bold tracking-tight text-[#5c4a3d] dark:text-[#e0d0c0]">é¥®é£Ÿè§‰å¯Ÿ</h2>
            </div>
            <a href="code.html"
                class="text-sm font-medium text-text-sub hover:text-primary transition-colors flex items-center gap-1">
                <span class="material-symbols-outlined text-lg">arrow_back</span>
                é‡æ–°é€‰æ‹©
            </a>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center p-4 sm:p-10">
        <div class="w-full max-w-2xl flex flex-col items-center gap-8">

            <!-- Loading State -->
            <div id="loading-state" class="text-center space-y-6 py-12">
                <div class="relative inline-flex">
                    <span class="material-symbols-outlined text-6xl text-primary pulse-soft">restaurant</span>
                </div>
                <div class="space-y-2">
                    <h2 class="text-2xl font-bold text-text-main dark:text-white font-serif">æ­£åœ¨å¯»æ‰¾æ…°è—‰...</h2>
                    <p class="text-text-sub">è®©æˆ‘æƒ³æƒ³ä»€ä¹ˆæœ€é€‚åˆæ­¤åˆ»çš„ä½ </p>
                </div>
            </div>

            <!-- Result State -->
            <div id="result-state" class="hidden w-full">
                <div class="text-center space-y-3 mb-8">
                    <h1
                        class="text-3xl sm:text-4xl font-extrabold tracking-tight text-text-main dark:text-white font-serif">
                        ç°åœ¨å°±åƒè¿™ä¸ª
                    </h1>
                    <p class="text-lg text-text-sub dark:text-[#bfae99] font-medium">
                        ä¸ºæ­¤åˆ»çš„ä½ ï¼Œç²¾é€‰äº†å‡ ä¸ªé€‰æ‹©
                    </p>
                </div>

                <div id="recommendations-container" class="space-y-4 mb-8">
                    <!-- Recommendations will be inserted here -->
                </div>

                <!-- é‡æ–°ç”ŸæˆæŒ‰é’® -->
                <div class="pt-4">
                    <a href="code.html"
                        class="w-full h-14 bg-accent-cream dark:bg-[#4a3a2f] hover:bg-[#f5e6d8] dark:hover:bg-[#5c4a3d] text-text-main dark:text-white rounded-2xl font-bold text-base transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">refresh</span>
                        ä¸æ»¡æ„ï¼Ÿé‡æ–°é€‰æ‹©
                    </a>
                </div>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden text-center space-y-6 py-12">
                <div class="relative inline-flex">
                    <span class="material-symbols-outlined text-6xl text-text-sub">sentiment_dissatisfied</span>
                </div>
                <div class="space-y-2">
                    <h2 class="text-2xl font-bold text-text-main dark:text-white font-serif">å‡ºäº†ç‚¹å°é—®é¢˜</h2>
                    <p id="error-message" class="text-text-sub">è¯·ç¨åå†è¯•</p>
                </div>
                <a href="code.html"
                    class="inline-flex items-center gap-2 px-6 py-3 bg-primary hover:bg-primary-hover text-white rounded-xl font-bold transition-all">
                    <span class="material-symbols-outlined">arrow_back</span>
                    è¿”å›é‡è¯•
                </a>
            </div>

        </div>
    </main>

    <footer class="py-6 text-center">
        <div class="flex justify-center gap-6 text-sm font-medium text-text-sub/70 dark:text-[#bfae99]/50">
            <a class="hover:text-primary transition-colors" href="#">éšç§æ”¿ç­–</a>
            <span>â€¢</span>
            <a class="hover:text-primary transition-colors" href="#">æœåŠ¡æ¡æ¬¾</a>
        </div>
    </footer>

    <script>
        // å¹³å°é…ç½®ï¼šåˆ†çº§è·³è½¬é“¾ï¼ˆApp -> å¤‡ç”¨App -> H5ç½‘é¡µï¼‰
        const PLATFORM_CONFIG = {
            meituan: {
                name: 'ç¾å›¢å¤–å–',
                icon: 'ğŸŸ¡',
                // ä¼˜å…ˆï¼šç¾å›¢å¤–å–Appä¸“ç”¨scheme
                app: (kw) => `waimai://search?keyword=${encodeURIComponent(kw)}`,
                // å¤‡ç”¨ï¼šç¾å›¢ä¸»App
                fallbackApp: (kw) => `imeituan://www.meituan.com/search?keyword=${encodeURIComponent(kw)}`,
                // å…œåº•ï¼šç½‘é¡µç‰ˆ
                web: (kw) => `https://waimai.meituan.com/search?keyword=${encodeURIComponent(kw)}`
            },
            eleme: {
                name: 'é¥¿äº†ä¹ˆ',
                icon: 'ğŸ”µ',
                app: (kw) => `eleme://search?keyword=${encodeURIComponent(kw)}`,
                fallbackApp: (kw) => `eleme://homepage`,
                web: (kw) => `https://h5.ele.me/search?keyword=${encodeURIComponent(kw)}`
            },
            jd: {
                name: 'äº¬ä¸œç§’é€',
                icon: 'ğŸ”´',
                // äº¬ä¸œç§’é€ï¼šä¼˜å…ˆä½¿ç”¨H5é“¾æ¥ï¼ˆäº¬ä¸œAppä¼šè‡ªåŠ¨æ‹¦æˆªï¼‰
                app: (kw) => `openapp.jdmobile://virtual?params=${encodeURIComponent(JSON.stringify({ category: 'jump', des: 'jdMartHome' }))}`,
                fallbackApp: (kw) => `https://jdmart.jd.com/search?keyword=${encodeURIComponent(kw)}`,
                web: (kw) => `https://jdmart.jd.com/search?keyword=${encodeURIComponent(kw)}`
            }
        };

        // åˆ†çº§è·³è½¬ï¼šApp -> å¤‡ç”¨App -> ç½‘é¡µ
        let jumpInProgress = false;

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showCopyToast('âœ… å·²å¤åˆ¶æœç´¢è¯ï¼Œåˆ°Appç²˜è´´æœç´¢å³å¯');
                return true;
            } catch (err) {
                // é™çº§æ–¹æ¡ˆ
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showCopyToast('âœ… å·²å¤åˆ¶æœç´¢è¯ï¼Œåˆ°Appç²˜è´´æœç´¢å³å¯');
                return true;
            }
        }

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        function showCopyToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-green-600 text-white px-5 py-3 rounded-xl shadow-lg z-50 text-sm font-medium flex items-center gap-2';
            toast.innerHTML = `<span class="material-symbols-outlined text-lg">content_paste</span>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.transition = 'opacity 0.3s, transform 0.3s';
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-10px)';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        function smartJump(platform, keyword) {
            if (jumpInProgress) return; // é˜²æ­¢é‡å¤è§¦å‘

            const config = PLATFORM_CONFIG[platform] || PLATFORM_CONFIG.meituan;
            const kw = keyword || 'å¤–å–';
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            // ç§»åŠ¨ç«¯ï¼šå¤åˆ¶å…³é”®è¯åˆ°å‰ªè´´æ¿ï¼ˆæ–¹ä¾¿ç”¨æˆ·ç²˜è´´æœç´¢ï¼‰
            if (isMobile) {
                copyToClipboard(kw);
            }

            if (!isMobile) {
                // PCç«¯ï¼šç›´æ¥æ‰“å¼€ç½‘é¡µ
                window.open(config.web(kw), '_blank');
                return;
            }

            jumpInProgress = true;
            let appOpened = false;

            // ç›‘å¬é¡µé¢å¤±ç„¦ï¼ˆAppæ‰“å¼€æˆåŠŸçš„ä¿¡å·ï¼‰
            const blurHandler = () => {
                appOpened = true;
                jumpInProgress = false;
            };
            window.addEventListener('blur', blurHandler, { once: true });

            // ç¬¬1æ­¥ï¼šå°è¯•ä¸»App
            const appUrl = config.app(kw);
            window.location.href = appUrl;

            // ç¬¬2æ­¥ï¼š1.5ç§’åæ£€æŸ¥ï¼Œå¦‚æœæ²¡æ‰“å¼€åˆ™å°è¯•å¤‡ç”¨
            setTimeout(() => {
                if (!appOpened && config.fallbackApp) {
                    window.location.href = config.fallbackApp(kw);

                    // ç¬¬3æ­¥ï¼šå†1.5ç§’åï¼Œå¦‚æœè¿˜æ²¡æ‰“å¼€åˆ™é™çº§åˆ°ç½‘é¡µ
                    setTimeout(() => {
                        if (!appOpened) {
                            window.removeEventListener('blur', blurHandler);
                            jumpInProgress = false;
                            // æœ€ç»ˆé™çº§ï¼šæ‰“å¼€ç½‘é¡µç‰ˆï¼ˆæ–°æ ‡ç­¾ï¼‰
                            window.open(config.web(kw), '_blank');
                        }
                    }, 1500);
                }
            }, 1500);

            // è¶…æ—¶æ¸…ç†
            setTimeout(() => {
                window.removeEventListener('blur', blurHandler);
                jumpInProgress = false;
            }, 5000);
        }

        // ç›´æ¥æ‰“å¼€ç½‘é¡µç‰ˆï¼ˆå¤‡ç”¨æŒ‰é’®ï¼‰
        function openWebVersion(platform, keyword) {
            const config = PLATFORM_CONFIG[platform] || PLATFORM_CONFIG.meituan;
            window.open(config.web(keyword || 'å¤–å–'), '_blank');
        }

        // è·å–å¹³å°å›¾æ ‡
        function getPlatformIcon(platform) {
            return PLATFORM_CONFIG[platform]?.icon || 'ğŸ“¦';
        }

        // è·å–å¹³å°åç§°
        function getPlatformName(platform) {
            return PLATFORM_CONFIG[platform]?.name || 'å¤–å–å¹³å°';
        }

        // å…¨å±€å­˜å‚¨å½“å‰æ¨èï¼ˆç”¨äºç‚¹å‡»æ—¶è·å–å®Œæ•´recå¯¹è±¡ï¼‰
        let currentRecommendations = [];
        let currentAlternatives = [];

        // å¤„ç†ä¸‹å•ç‚¹å‡»
        function handleOrderClick(index, isAlternative = false) {
            const rec = isAlternative ? currentAlternatives[index] : currentRecommendations[index];
            if (!rec) return;
            const keyword = rec.jump_keyword || `${rec.restaurant || ''} ${rec.food_name}`;
            smartJump(rec.platform, keyword, rec);
        }

        // æ¨èå¡ç‰‡æ¨¡æ¿ï¼ˆä¼˜åŒ–ç‰ˆï¼šå«å•†å®¶åã€æ™ºèƒ½è·³è½¬ï¼‰
        function createRecommendationCard(rec, index) {
            const {
                food_name,
                restaurant,
                platform,
                estimated_price,
                reason,
                jump_keyword,
                regret_score,
                regret_reason
            } = rec;

            // ç”Ÿæˆåæ‚”æŒ‡æ•°æ˜Ÿæ˜Ÿ
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                const filled = i <= regret_score;
                starsHtml += `<span class="material-symbols-outlined text-base ${filled ? 'text-primary' : 'text-[#e0d5ca] dark:text-[#5c4a3d]'}">star</span>`;
            }

            const priceDisplay = estimated_price ? `Â¥${estimated_price}` : '';
            const keyword = jump_keyword || `${restaurant} ${food_name}`;

            return `
                <div class="recommendation-card bg-card-light dark:bg-card-dark rounded-2xl border border-[#f0e6da] dark:border-[#4a3a2f] p-5 sm:p-6 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex flex-col gap-3">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-accent-cream dark:bg-[#4a3a2f] flex items-center justify-center flex-shrink-0 text-xl">
                                    ${getPlatformIcon(platform)}
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-text-main dark:text-white">${food_name}</h3>
                                    <p class="text-xs text-text-sub">${restaurant || ''}</p>
                                    <span class="text-xs text-text-sub bg-accent-cream dark:bg-[#4a3a2f] px-2 py-0.5 rounded-full">${getPlatformName(platform)}</span>
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <div class="text-xl font-bold text-primary">${priceDisplay}</div>
                            </div>
                        </div>
                        
                        <p class="text-text-sub dark:text-[#bfae99] text-sm">${reason || ''}</p>
                        
                        <div class="flex items-center justify-between pt-2 border-t border-[#f0e6da] dark:border-[#4a3a2f]">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-medium text-text-sub">åæ‚”æŒ‡æ•°</span>
                                <div class="flex gap-0.5">${starsHtml}</div>
                            </div>
                        </div>
                        ${regret_reason ? `<p class="text-xs text-text-sub/70 dark:text-[#887860]">ğŸ‘‰ ${regret_reason}</p>` : ''}
                        
                        <!-- ä¸‹å•æŒ‰é’®ç»„ -->
                        <div class="mt-2 flex gap-2">
                            <button onclick="handleOrderClick(${index})"
                               class="flex-1 h-12 bg-primary hover:bg-primary-hover text-white rounded-xl font-bold text-sm shadow-md shadow-primary/20 transition-all flex items-center justify-center gap-2 cursor-pointer">
                                <span class="material-symbols-outlined text-lg">shopping_cart</span>
                                å»ä¸‹å•
                            </button>
                            <button onclick="confirmOrdered(${index})"
                               class="flex-1 h-12 bg-green-500 hover:bg-green-600 text-white rounded-xl font-bold text-sm shadow-md shadow-green-500/20 transition-all flex items-center justify-center gap-2 cursor-pointer">
                                <span class="material-symbols-outlined text-lg">check_circle</span>
                                æˆ‘å·²ä¸‹å•
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ›¿ä»£é€‰é¡¹å¡ç‰‡ï¼ˆå«å•†å®¶åå’Œæ™ºèƒ½è·³è½¬ï¼‰
        function createAlternativeCard(alt, index) {
            const keyword = alt.jump_keyword || `${alt.restaurant || ''} ${alt.food_name}`;
            return `
                <button onclick="handleOrderClick(${index}, true)" 
                   class="flex items-center gap-3 p-3 bg-accent-cream/50 dark:bg-[#3a2e26] rounded-xl hover:bg-accent-cream dark:hover:bg-[#4a3a2f] transition-colors cursor-pointer w-full text-left">
                    <span class="text-lg">${getPlatformIcon(alt.platform)}</span>
                    <div class="flex-1">
                        <span class="font-medium text-text-main dark:text-white text-sm">${alt.food_name}</span>
                        <span class="text-xs text-text-sub ml-2">${alt.restaurant || ''}</span>
                    </div>
                    <span class="material-symbols-outlined text-primary text-lg">arrow_forward</span>
                </button>
            `;
        }

        // ä¸æ¨èé¡¹å¡ç‰‡
        function createNotRecommendedCard(item) {
            return `
                <div class="flex items-center gap-3 p-3 bg-red-50/50 dark:bg-red-900/10 rounded-xl border border-red-100 dark:border-red-900/20">
                    <span class="material-symbols-outlined text-red-400">block</span>
                    <div class="flex-1">
                        <span class="font-medium text-text-main dark:text-white text-sm">${item.food_name}</span>
                    </div>
                    <span class="text-xs text-red-500">${item.reason || ''}</span>
                </div>
            `;
        }

        // æ˜¾ç¤ºä¸åŒçŠ¶æ€
        function showLoading() {
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('result-state').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
        }

        function showResult(data) {
            const container = document.getElementById('recommendations-container');
            let html = '';

            // å­˜å‚¨åˆ°å…¨å±€å˜é‡ï¼ˆç”¨äºç‚¹å‡»æ—¶è·å–å®Œæ•´å¯¹è±¡ï¼‰
            currentRecommendations = data.recommendations || [];
            currentAlternatives = data.alternatives || [];

            // ä¸»æ¨è
            if (data.recommendations && data.recommendations.length > 0) {
                html += data.recommendations.map((rec, i) => createRecommendationCard(rec, i)).join('');
            }

            // æ›¿ä»£é€‰é¡¹
            if (data.alternatives && data.alternatives.length > 0) {
                html += `
                    <div class="mt-6 space-y-2">
                        <h4 class="text-sm font-bold text-text-sub flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">lightbulb</span>
                            å¦‚æœä¸Šé¢çš„ä¸åˆå£å‘³ï¼Œè¿˜å¯ä»¥è¯•è¯•
                        </h4>
                        ${data.alternatives.map((alt, i) => createAlternativeCard(alt, i)).join('')}
                    </div>
                `;
            }

            // ä¸æ¨èé¡¹
            if (data.not_recommended && data.not_recommended.length > 0) {
                html += `
                    <div class="mt-6 space-y-2">
                        <h4 class="text-sm font-bold text-text-sub flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">warning</span>
                            ä»Šæ™šä¸å¤ªå»ºè®®
                        </h4>
                        ${data.not_recommended.map(item => createNotRecommendedCard(item)).join('')}
                    </div>
                `;
            }

            container.innerHTML = html;

            // æ›´æ–°é¡µé¢æ ‡é¢˜ä¿¡æ¯
            if (data.current_time) {
                document.querySelector('#result-state p').innerHTML =
                    `å½“å‰ ${data.current_time} Â· ${data.scene || 'å¤œå®µåœºæ™¯'} Â· ${data.guilt_level || ''}`;
            }

            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('result-state').classList.remove('hidden');
            document.getElementById('error-state').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message || 'è¯·ç¨åå†è¯•';
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('result-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
        }

        // ==========================================
        // æ¸¸å®¢IDç³»ç»Ÿ + ä¸´æ—¶æ•°æ®æœºåˆ¶
        // ==========================================

        // è·å–æˆ–ç”Ÿæˆæ¸¸å®¢ID
        function getGuestId() {
            let guestId = localStorage.getItem('guest_id');
            if (!guestId) {
                guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('guest_id', guestId);
            }
            return guestId;
        }

        // ä¸´æ—¶é€‰æ‹©æ•°æ®
        let tempSelection = null;
        let confirmTimer = null;

        // ç”¨æˆ·ç‚¹å‡»æ¨èå¡ç‰‡æ—¶è®°å½•ä¸´æ—¶é€‰æ‹©
        function recordTempSelection(rec, platform, keyword) {
            const guestId = getGuestId();

            // æ¸…é™¤ä¹‹å‰çš„ç¡®è®¤å®šæ—¶å™¨
            if (confirmTimer) {
                clearTimeout(confirmTimer);
            }

            // è®°å½•ä¸´æ—¶é€‰æ‹©
            tempSelection = {
                guest_id: guestId,
                food_name: rec.food_name,
                restaurant: rec.restaurant,
                platform: platform,
                keyword: keyword,
                estimated_price: rec.estimated_price,
                timestamp: Date.now(),
                confirmed: false
            };

            // å­˜å‚¨åˆ° sessionStorageï¼ˆä¸´æ—¶ï¼‰
            sessionStorage.setItem('temp_selection', JSON.stringify(tempSelection));

            console.log('ä¸´æ—¶é€‰æ‹©å·²è®°å½•ï¼Œ120ç§’åç¡®è®¤:', tempSelection);

            // 120ç§’åè‡ªåŠ¨ç¡®è®¤ä¸ºçœŸå®æ•°æ®
            confirmTimer = setTimeout(() => {
                confirmSelection();
            }, 120000); // 120ç§’
        }

        // ç¡®è®¤é€‰æ‹©ä¸ºçœŸå®æ•°æ®
        async function confirmSelection() {
            const guestId = getGuestId();
            const tempData = sessionStorage.getItem('temp_selection');

            if (!tempData) return;

            try {
                const selection = JSON.parse(tempData);
                selection.confirmed = true;
                selection.confirmed_at = Date.now();

                // å­˜å‚¨åˆ° localStorageï¼ˆæŒä¹…åŒ–ï¼‰
                const history = JSON.parse(localStorage.getItem('selection_history') || '[]');
                history.push(selection);
                // åªä¿ç•™æœ€è¿‘30æ¡
                if (history.length > 30) history.shift();
                localStorage.setItem('selection_history', JSON.stringify(history));

                // æ¸…é™¤ä¸´æ—¶æ•°æ®
                sessionStorage.removeItem('temp_selection');
                console.log('é€‰æ‹©å·²ç¡®è®¤ä¸ºçœŸå®æ•°æ®:', selection);

                // å¯é€‰ï¼šå‘é€åˆ°åç«¯
                // await saveToBackend(selection);
            } catch (e) {
                console.error('ç¡®è®¤é€‰æ‹©å¤±è´¥:', e);
            }
        }

        // "æˆ‘å·²ä¸‹å•"æŒ‰é’® - ç«‹å³ç¡®è®¤å¹¶è·³è½¬åˆ°å¤ç›˜é¡µé¢
        async function confirmOrdered(index, isAlternative = false) {
            const rec = isAlternative ? currentAlternatives[index] : currentRecommendations[index];
            if (!rec) {
                alert('æ‰¾ä¸åˆ°é€‰æ‹©çš„èœå“');
                return;
            }

            const guestId = getGuestId();
            const userToken = localStorage.getItem('user_token') || generateUserToken();

            // ç”Ÿæˆç”¨æˆ·token
            function generateUserToken() {
                const token = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('user_token', token);
                return token;
            }

            // ä¿å­˜å·²ä¸‹å•è®°å½•åˆ°æ•°æ®åº“
            const orderData = {
                user_token: userToken,
                food_name: rec.food_name,
                price: parseFloat(rec.estimated_price) || 0,
                fullness: 2, // é»˜è®¤åˆšå¥½
                mood: 'satisfied', // é»˜è®¤æ»¡è¶³
                regret_score: rec.regret_score || 2,
                note: `${rec.restaurant || 'å¤–å–'} - é€šè¿‡${getPlatformName(rec.platform)}ä¸‹å•`,
                created_at: new Date().toISOString()
            };

            try {
                const SUPABASE_URL = 'https://lqqdhlxcfmdgxdayxxsi.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcWRobHhjZm1kZ3hkYXl4eHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTQzNzAsImV4cCI6MjA4NTI3MDM3MH0.TkFKzi_UgHjvzgK1zH4thEjQ3fuuotAPwjfkwptdvqU';

                const response = await fetch(`${SUPABASE_URL}/rest/v1/meal_reviews`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    // æ¸…é™¤ä¸´æ—¶æ•°æ®
                    if (confirmTimer) clearTimeout(confirmTimer);
                    sessionStorage.removeItem('temp_selection');

                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    alert(`âœ… å·²è®°å½•: ${rec.food_name}\n\nç¥ä½ åƒå¾—å¼€å¿ƒï¼`);

                    // è·³è½¬åˆ°å¤ç›˜å†å²é¡µ
                    window.location.href = 'review-history.html';
                } else {
                    const err = await response.text();
                    console.error('ä¿å­˜å¤±è´¥:', err);
                    alert('è®°å½•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                }
            } catch (error) {
                console.error('ç½‘ç»œé”™è¯¯:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
            }
        }

        // ä¿®æ”¹ smartJump å‡½æ•°ï¼Œåœ¨è·³è½¬æ—¶è®°å½•é€‰æ‹©
        const originalSmartJump = smartJump;
        smartJump = function (platform, keyword, rec) {
            // è®°å½•ä¸´æ—¶é€‰æ‹©
            if (rec) {
                recordTempSelection(rec, platform, keyword);
            }
            // æ‰§è¡ŒåŸè·³è½¬é€»è¾‘
            originalSmartJump(platform, keyword);
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // åˆå§‹åŒ–æ¸¸å®¢ID
            const guestId = getGuestId();
            console.log('æ¸¸å®¢ID:', guestId);

            const storedData = sessionStorage.getItem('recommendations');

            if (storedData) {
                try {
                    const data = JSON.parse(storedData);
                    if (data.recommendations && data.recommendations.length > 0) {
                        setTimeout(() => showResult(data), 800);
                    } else {
                        showError('æ²¡æœ‰æ‰¾åˆ°æ¨èç»“æœ');
                    }
                } catch (e) {
                    console.error('è§£æé”™è¯¯:', e);
                    showError('æ•°æ®è§£æå¤±è´¥');
                }
            } else {
                setTimeout(() => {
                    showError('è¯·å…ˆå®Œæˆé—®å·');
                }, 1000);
            }

            // é¡µé¢å¸è½½å‰æ£€æŸ¥æ˜¯å¦æœ‰å¾…ç¡®è®¤çš„é€‰æ‹©
            window.addEventListener('beforeunload', () => {
                // å¦‚æœç”¨æˆ·ç¦»å¼€é¡µé¢è¶…è¿‡120ç§’ï¼Œåœ¨ä¸‹æ¬¡è®¿é—®æ—¶ç¡®è®¤
                const tempData = sessionStorage.getItem('temp_selection');
                if (tempData) {
                    const selection = JSON.parse(tempData);
                    // å¦‚æœè·ç¦»é€‰æ‹©å·²è¶…è¿‡120ç§’ï¼Œç«‹å³ç¡®è®¤
                    if (Date.now() - selection.timestamp > 120000) {
                        confirmSelection();
                    }
                }
            });
        });
    </script>
</body>

</html>