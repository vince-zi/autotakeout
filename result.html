<!DOCTYPE html>
<html class="light" lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>ä»Šæ™šå°±åƒè¿™ä¸ª - é¥®é£Ÿè§‰å¯Ÿ</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ff9478",
                        "primary-hover": "#ff7e5f",
                        "background-light": "#fff9f2",
                        "background-dark": "#2d231e",
                        "card-light": "#ffffff",
                        "card-dark": "#3a2e26",
                        "text-main": "#4a3b32",
                        "text-sub": "#9c8676",
                        "accent-cream": "#faefe6",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "system-ui", "sans-serif"],
                        "serif": ["Noto Serif SC", "serif"],
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "2xl": "2rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .recommendation-card {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }

        .recommendation-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .recommendation-card:nth-child(2) {
            animation-delay: 0.25s;
        }

        .recommendation-card:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .regret-star {
            transition: all 0.2s ease;
        }

        .pulse-soft {
            animation: pulseSoft 2s ease-in-out infinite;
        }

        @keyframes pulseSoft {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-text-main dark:text-[#ede0d4] font-display min-h-screen flex flex-col overflow-x-hidden transition-colors duration-300 selection:bg-primary/20">
    <header
        class="w-full border-b border-[#f0e6da] dark:border-[#4a3a2f] bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="text-primary">
                    <span class="material-symbols-outlined text-3xl">local_dining</span>
                </div>
                <h2 class="text-lg font-bold tracking-tight text-[#5c4a3d] dark:text-[#e0d0c0]">é¥®é£Ÿè§‰å¯Ÿ</h2>
            </div>
            <a href="code.html"
                class="text-sm font-medium text-text-sub hover:text-primary transition-colors flex items-center gap-1">
                <span class="material-symbols-outlined text-lg">arrow_back</span>
                é‡æ–°é€‰æ‹©
            </a>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center p-4 sm:p-10">
        <div class="w-full max-w-2xl flex flex-col items-center gap-8">

            <!-- Loading State -->
            <div id="loading-state" class="text-center space-y-6 py-12">
                <div class="relative inline-flex">
                    <span class="material-symbols-outlined text-6xl text-primary pulse-soft">restaurant</span>
                </div>
                <div class="space-y-2">
                    <h2 class="text-2xl font-bold text-text-main dark:text-white font-serif">æ­£åœ¨å¯»æ‰¾æ…°è—‰...</h2>
                    <p class="text-text-sub">è®©æˆ‘æƒ³æƒ³ä»€ä¹ˆæœ€é€‚åˆæ­¤åˆ»çš„ä½ </p>
                </div>
            </div>

            <!-- Result State -->
            <div id="result-state" class="hidden w-full">
                <div class="text-center space-y-3 mb-8">
                    <h1
                        class="text-3xl sm:text-4xl font-extrabold tracking-tight text-text-main dark:text-white font-serif">
                        ä»Šæ™šå°±åƒè¿™ä¸ª
                    </h1>
                    <p class="text-lg text-text-sub dark:text-[#bfae99] font-medium">
                        ä¸ºæ­¤åˆ»çš„ä½ ï¼Œç²¾é€‰äº†å‡ ä¸ªé€‰æ‹©
                    </p>
                </div>

                <div id="recommendations-container" class="space-y-4 mb-8">
                    <!-- Recommendations will be inserted here -->
                </div>

                <div class="flex flex-col sm:flex-row gap-3 pt-4">
                    <a href="code.html"
                        class="flex-1 h-14 bg-accent-cream dark:bg-[#4a3a2f] hover:bg-[#f5e6d8] dark:hover:bg-[#5c4a3d] text-text-main dark:text-white rounded-2xl font-bold text-base transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">refresh</span>
                        å†æƒ³æƒ³
                    </a>
                    <button id="confirm-btn"
                        class="flex-1 h-14 bg-primary hover:bg-primary-hover text-white rounded-2xl font-bold text-base shadow-lg shadow-primary/20 hover:shadow-primary/30 transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">check_circle</span>
                        å°±è¿™ä¹ˆå®šäº†
                    </button>
                </div>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden text-center space-y-6 py-12">
                <div class="relative inline-flex">
                    <span class="material-symbols-outlined text-6xl text-text-sub">sentiment_dissatisfied</span>
                </div>
                <div class="space-y-2">
                    <h2 class="text-2xl font-bold text-text-main dark:text-white font-serif">å‡ºäº†ç‚¹å°é—®é¢˜</h2>
                    <p id="error-message" class="text-text-sub">è¯·ç¨åå†è¯•</p>
                </div>
                <a href="code.html"
                    class="inline-flex items-center gap-2 px-6 py-3 bg-primary hover:bg-primary-hover text-white rounded-xl font-bold transition-all">
                    <span class="material-symbols-outlined">arrow_back</span>
                    è¿”å›é‡è¯•
                </a>
            </div>

        </div>
    </main>

    <footer class="py-6 text-center">
        <div class="mb-4">
            <a href="review.html"
                class="inline-flex items-center gap-2 px-5 py-2.5 bg-accent-cream dark:bg-[#3a2e26] text-primary rounded-xl font-medium hover:bg-primary hover:text-white transition-all">
                <span class="material-symbols-outlined">edit_note</span>
                åƒå®Œåè®°å½•ä¸€ä¸‹
            </a>
        </div>
        <div class="flex justify-center gap-6 text-sm font-medium text-text-sub/70 dark:text-[#bfae99]/50">
            <a class="hover:text-primary transition-colors" href="review-history.html">ğŸ“Š é¥®é£ŸæŠ¥å‘Š</a>
            <span>â€¢</span>
            <a class="hover:text-primary transition-colors" href="#">éšç§æ”¿ç­–</a>
            <span>â€¢</span>
            <a class="hover:text-primary transition-colors" href="#">æœåŠ¡æ¡æ¬¾</a>
        </div>
    </footer>

    <script>
        // å¹³å°é…ç½®ï¼šApp Scheme + ç½‘é¡µå¤‡ç”¨
        const PLATFORM_CONFIG = {
            meituan: {
                name: 'ç¾å›¢å¤–å–',
                icon: 'ğŸŸ¡',
                app: (kw) => `imeituan://www.meituan.com/search?keyword=${encodeURIComponent(kw)}`,
                web: (kw) => `https://waimai.meituan.com/search?keyword=${encodeURIComponent(kw)}`
            },
            eleme: {
                name: 'æ·˜å®é—ªè´­',  // é¥¿äº†ä¹ˆå·²æ›´åä¸ºæ·˜å®é—ªè´­
                icon: 'ğŸŸ ',
                // æ·˜å®é—ªè´­å¯ä»¥ç›´æ¥æ‰“å¼€å•†å“æœç´¢ï¼Œç”¨æˆ·åªéœ€åŠ è´­
                app: (kw) => `taobao://s.taobao.com/search?q=${encodeURIComponent(kw + ' é—ªè´­')}`,
                web: (kw) => `https://s.taobao.com/search?initiative_id=staobaoz_20200101&q=${encodeURIComponent(kw + ' é—ªè´­ å³æ—¶é…é€')}`
            },
            taobao: {
                name: 'æ·˜å®',
                icon: 'ğŸŸ ',
                app: (kw) => `taobao://s.taobao.com/search?q=${encodeURIComponent(kw)}`,
                web: (kw) => `https://s.taobao.com/search?q=${encodeURIComponent(kw)}`
            },
            jd: {
                name: 'äº¬ä¸œç§’é€',
                icon: 'ğŸ”´',
                // äº¬ä¸œç§’é€ï¼Œæ·»åŠ "ç§’é€"å…³é”®è¯ä¼˜å…ˆå±•ç¤ºå³æ—¶é…é€
                app: (kw) => `openapp.jdmobile://virtual?params={"category":"jump","des":"search","keyword":"${encodeURIComponent(kw + ' ç§’é€')}"}`,
                web: (kw) => `https://search.jd.com/Search?keyword=${encodeURIComponent(kw + ' ç§’é€')}`
            }
        };

        // æ™ºèƒ½è·³è½¬ï¼šå…ˆå°è¯•Appï¼Œå¤±è´¥åˆ™é™çº§åˆ°ç½‘é¡µ
        function smartJump(platform, keyword) {
            const config = PLATFORM_CONFIG[platform] || PLATFORM_CONFIG.meituan;
            const kw = keyword || 'å¤œå®µ';

            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            if (isMobile) {
                // ç§»åŠ¨ç«¯ï¼šå°è¯•æ‰“å¼€App
                const appUrl = config.app(kw);
                const webUrl = config.web(kw);

                // ä½¿ç”¨éšè—iframeå°è¯•æ‰“å¼€App
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = appUrl;
                document.body.appendChild(iframe);

                // 2.5ç§’åå¦‚æœAppæœªå¯åŠ¨ï¼Œé™çº§åˆ°ç½‘é¡µ
                setTimeout(() => {
                    document.body.removeChild(iframe);
                    window.location.href = webUrl;
                }, 2500);
            } else {
                // PCç«¯ï¼šç›´æ¥æ‰“å¼€ç½‘é¡µ
                window.open(config.web(kw), '_blank');
            }
        }

        // è·å–å¹³å°å›¾æ ‡
        function getPlatformIcon(platform) {
            return PLATFORM_CONFIG[platform]?.icon || 'ğŸ“¦';
        }

        // è·å–å¹³å°åç§°
        function getPlatformName(platform) {
            return PLATFORM_CONFIG[platform]?.name || 'å¤–å–å¹³å°';
        }

        // æ¨èå¡ç‰‡æ¨¡æ¿ï¼ˆä¼˜åŒ–ç‰ˆï¼šå«å•†å®¶åã€æ™ºèƒ½è·³è½¬ï¼‰
        function createRecommendationCard(rec, index) {
            const {
                food_name,
                restaurant,
                platform,
                estimated_price,
                reason,
                jump_keyword,
                regret_score,
                regret_reason
            } = rec;

            // ç”Ÿæˆåæ‚”æŒ‡æ•°æ˜Ÿæ˜Ÿ
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                const filled = i <= regret_score;
                starsHtml += `<span class="material-symbols-outlined text-base ${filled ? 'text-primary' : 'text-[#e0d5ca] dark:text-[#5c4a3d]'}">star</span>`;
            }

            const priceDisplay = estimated_price ? `Â¥${estimated_price}` : '';
            const keyword = jump_keyword || `${restaurant} ${food_name}`;

            return `
                <div class="recommendation-card bg-card-light dark:bg-card-dark rounded-2xl border border-[#f0e6da] dark:border-[#4a3a2f] p-5 sm:p-6 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex flex-col gap-3">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-accent-cream dark:bg-[#4a3a2f] flex items-center justify-center flex-shrink-0 text-xl">
                                    ${getPlatformIcon(platform)}
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-text-main dark:text-white">${food_name}</h3>
                                    <p class="text-xs text-text-sub">${restaurant || ''}</p>
                                    <span class="text-xs text-text-sub bg-accent-cream dark:bg-[#4a3a2f] px-2 py-0.5 rounded-full">${getPlatformName(platform)}</span>
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <div class="text-xl font-bold text-primary">${priceDisplay}</div>
                            </div>
                        </div>
                        
                        <p class="text-text-sub dark:text-[#bfae99] text-sm">${reason || ''}</p>
                        
                        <div class="flex items-center justify-between pt-2 border-t border-[#f0e6da] dark:border-[#4a3a2f]">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-medium text-text-sub">åæ‚”æŒ‡æ•°</span>
                                <div class="flex gap-0.5">${starsHtml}</div>
                            </div>
                        </div>
                        ${regret_reason ? `<p class="text-xs text-text-sub/70 dark:text-[#887860]">ğŸ‘‰ ${regret_reason}</p>` : ''}
                        
                        <!-- å»ä¸‹å•æŒ‰é’®ï¼ˆæ™ºèƒ½è·³è½¬ï¼šAppä¼˜å…ˆï¼‰ -->
                        <button onclick="smartJump('${platform}', '${keyword.replace(/'/g, "\\'")}')"
                           class="mt-2 w-full h-12 bg-primary hover:bg-primary-hover text-white rounded-xl font-bold text-sm shadow-md shadow-primary/20 transition-all flex items-center justify-center gap-2 cursor-pointer">
                            <span class="material-symbols-outlined text-lg">shopping_cart</span>
                            å»${getPlatformName(platform)}ä¸‹å•
                        </button>
                    </div>
                </div>
            `;
        }

        // æ›¿ä»£é€‰é¡¹å¡ç‰‡ï¼ˆå«å•†å®¶åå’Œæ™ºèƒ½è·³è½¬ï¼‰
        function createAlternativeCard(alt) {
            const keyword = alt.jump_keyword || `${alt.restaurant || ''} ${alt.food_name}`;
            return `
                <button onclick="smartJump('${alt.platform}', '${keyword.replace(/'/g, "\\'")}')" 
                   class="flex items-center gap-3 p-3 bg-accent-cream/50 dark:bg-[#3a2e26] rounded-xl hover:bg-accent-cream dark:hover:bg-[#4a3a2f] transition-colors cursor-pointer w-full text-left">
                    <span class="text-lg">${getPlatformIcon(alt.platform)}</span>
                    <div class="flex-1">
                        <span class="font-medium text-text-main dark:text-white text-sm">${alt.food_name}</span>
                        <span class="text-xs text-text-sub ml-2">${alt.restaurant || ''}</span>
                    </div>
                    <span class="material-symbols-outlined text-primary text-lg">arrow_forward</span>
                </button>
            `;
        }

        // ä¸æ¨èé¡¹å¡ç‰‡
        function createNotRecommendedCard(item) {
            return `
                <div class="flex items-center gap-3 p-3 bg-red-50/50 dark:bg-red-900/10 rounded-xl border border-red-100 dark:border-red-900/20">
                    <span class="material-symbols-outlined text-red-400">block</span>
                    <div class="flex-1">
                        <span class="font-medium text-text-main dark:text-white text-sm">${item.food_name}</span>
                    </div>
                    <span class="text-xs text-red-500">${item.reason || ''}</span>
                </div>
            `;
        }

        // æ˜¾ç¤ºä¸åŒçŠ¶æ€
        function showLoading() {
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('result-state').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
        }

        function showResult(data) {
            const container = document.getElementById('recommendations-container');
            let html = '';

            // ä¸»æ¨è
            if (data.recommendations && data.recommendations.length > 0) {
                html += data.recommendations.map((rec, i) => createRecommendationCard(rec, i)).join('');
            }

            // æ›¿ä»£é€‰é¡¹
            if (data.alternatives && data.alternatives.length > 0) {
                html += `
                    <div class="mt-6 space-y-2">
                        <h4 class="text-sm font-bold text-text-sub flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">lightbulb</span>
                            å¦‚æœä¸Šé¢çš„ä¸åˆå£å‘³ï¼Œè¿˜å¯ä»¥è¯•è¯•
                        </h4>
                        ${data.alternatives.map(alt => createAlternativeCard(alt)).join('')}
                    </div>
                `;
            }

            // ä¸æ¨èé¡¹
            if (data.not_recommended && data.not_recommended.length > 0) {
                html += `
                    <div class="mt-6 space-y-2">
                        <h4 class="text-sm font-bold text-text-sub flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">warning</span>
                            ä»Šæ™šä¸å¤ªå»ºè®®
                        </h4>
                        ${data.not_recommended.map(item => createNotRecommendedCard(item)).join('')}
                    </div>
                `;
            }

            container.innerHTML = html;

            // æ›´æ–°é¡µé¢æ ‡é¢˜ä¿¡æ¯
            if (data.current_time) {
                document.querySelector('#result-state p').innerHTML =
                    `å½“å‰ ${data.current_time} Â· ${data.scene || 'å¤œå®µåœºæ™¯'} Â· ${data.guilt_level || ''}`;
            }

            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('result-state').classList.remove('hidden');
            document.getElementById('error-state').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message || 'è¯·ç¨åå†è¯•';
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('result-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            const storedData = sessionStorage.getItem('recommendations');

            if (storedData) {
                try {
                    const data = JSON.parse(storedData);
                    if (data.recommendations && data.recommendations.length > 0) {
                        setTimeout(() => showResult(data), 800);
                    } else {
                        showError('æ²¡æœ‰æ‰¾åˆ°æ¨èç»“æœ');
                    }
                } catch (e) {
                    console.error('è§£æé”™è¯¯:', e);
                    showError('æ•°æ®è§£æå¤±è´¥');
                }
            } else {
                setTimeout(() => {
                    showError('è¯·å…ˆå®Œæˆé—®å·');
                }, 1000);
            }
        });

        // ç¡®è®¤æŒ‰é’®
        document.getElementById('confirm-btn').addEventListener('click', function () {
            sessionStorage.removeItem('recommendations');
            this.innerHTML = '<span class="material-symbols-outlined">favorite</span> ç¥ä½ åƒå¾—å¼€å¿ƒï¼';
            this.disabled = true;
            this.classList.add('bg-green-500', 'hover:bg-green-500');
            this.classList.remove('bg-primary', 'hover:bg-primary-hover');

            setTimeout(() => {
                window.location.href = 'code.html';
            }, 1500);
        });
    </script>
</body>

</html>